# MIDIã‚¨ãƒ‡ã‚£ã‚¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ—¥**: 2025-12-08
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: `/src` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã€ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ `afa528b5446990643cc6bf811a54461516a30b77`
**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡**: ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã®è‰¯ã•ã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã€æ‹¡å¼µå®¹æ˜“æ€§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹/å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€æ„Ÿã‚’é‡è¦–

---

## ğŸ“‹ ç›®æ¬¡

1. [å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³](#1-å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³)
2. [å‘½åã®ä¸€è²«æ€§ã®å•é¡Œ](#2-å‘½åã®ä¸€è²«æ€§ã®å•é¡Œ)
3. [DI ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ‰åŠ¹æ€§è©•ä¾¡](#3-di-ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ‰åŠ¹æ€§è©•ä¾¡)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡Œ](#4-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡Œ)
5. [æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãƒ»ç°¡æ½”åŒ–ã®æ©Ÿä¼š](#5-æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ç°¡æ½”åŒ–ã®æ©Ÿä¼š)
6. [ãã®ä»–ã®å•é¡Œ](#6-ãã®ä»–ã®å•é¡Œ)
7. [æ”¹å–„å„ªå…ˆåº¦](#7-æ”¹å–„å„ªå…ˆåº¦)

---

## 1. å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³

### âœ… RESOLVED: 6ã¤ã®ä¸»è¦ãªæ”¹å–„ãŒå®Ÿç¾

#### 1.1 GetInstrument é–¢æ•°ã®å‰Šé™¤ âœ…

**å‰å›ã®æŒ‡æ‘˜**: `src/usecases/GetInstrument.ts` ã¯ `InstrumentStore.getOrLoad()` ã¸ã®å˜ãªã‚‹ãƒ—ãƒ­ã‚­ã‚·

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã€ã‚³ãƒ¼ãƒ‰ãŒç›´æ¥ `instrumentStore.getOrLoad()` ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«å¤‰æ›´
- **Location**: `src/Player/Player.ts:83-84`

**è©•ä¾¡**: ç´ æ™´ã‚‰ã—ã„ã€‚å†—é•·ãªæŠ½è±¡åŒ–ãŒæ’é™¤ã•ã‚Œã€ã‚³ãƒ¼ãƒ‰ãŒã‚ˆã‚Šç›´æ¥çš„ã«ãªã£ãŸã€‚

---

#### 1.2 App.ts ã®è²¬å‹™åˆ†å‰² âœ…âœ…

**å‰å›ã®æŒ‡æ‘˜**: App.ts ãŒ21å€‹ã®ä¾å­˜æ€§ã‚’æŒã¡ã€å…¨å±¤ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ…âœ… å¤§å¹…ãªæ”¹å–„
- App.ts ãŒ `src/App/KeyboardHandler.ts` ã«åå‰å¤‰æ›´
- **ä¾å­˜æ€§ãŒ 21 â†’ 4 ã«å‰Šæ¸›** (-81%)
  1. `PianoRoll`
  2. `EditHistoryManager`
  3. `ClipboardManager`
  4. `Player`
- **ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: ~165è¡Œ â†’ 117è¡Œ (-29%)
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãŒä¸€ç®‡æ‰€ã«é›†ç´„ã•ã‚Œã‚‹

**è©•ä¾¡**: æœ€å¤§ã®æ”¹å–„ã€‚å˜ä¸€è²¬ä»»åŸå‰‡ã‚’ã»ã¼é”æˆã€‚

---

#### 1.3 AppState.ts ã®å‰Šé™¤ âœ…

**å‰å›ã®æŒ‡æ‘˜**: è‚¥å¤§åŒ–ã—ãŸ App.ts ã®ä¸€éƒ¨

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã€çŠ¶æ…‹ç®¡ç†ãŒç°¡æ½”åŒ–

**è©•ä¾¡**: ä¸è¦ãªçŠ¶æ…‹å±¤ãŒæ’é™¤ã•ã‚ŒãŸã€‚

---

#### 1.4 Command.ts ã®å‰Šé™¤ âœ…

**å‰å›ã®æŒ‡æ‘˜**: Command ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸å®Œå…¨ãªå®Ÿè£…

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤

**è©•ä¾¡**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã£ã¦ä¸è¦ã«ãªã£ãŸã€‚

---

#### 1.5 FileStore â†’ SongStore ã¸ã®å†è¨­è¨ˆ âœ…

**å‰å›ã®æŒ‡æ‘˜**: FileStore ãŒè²¬å‹™ãŒä¸æ˜ç¢º (ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ + Song çŠ¶æ…‹ç®¡ç†ã®æ··åœ¨)

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… å¤§å¹…ã«æ”¹å–„
- FileStore.ts ãŒå‰Šé™¤
- æ–°ã—ã„ `src/SongStore.ts` (74è¡Œ) - ã‚·ãƒ³ãƒ—ãƒ«ã§æ˜ç¢º
- æ–°ã—ã„ `src/models/Song.ts` (128è¡Œ) - ç´”ç²‹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
- **è²¬å‹™ãŒæ˜ç¢ºã«åˆ†é›¢**:
  - `Song` = ä¸å¤‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
  - `SongStore` = Stateful ãªãƒ©ãƒƒãƒ‘ãƒ¼ã€EventBus é€£æº

**è©•ä¾¡**: ç´ æ™´ã‚‰ã—ã„ã€‚å±¤æ§‹é€ ãŒæ˜ç¢ºã«ãªã£ãŸã€‚

---

#### 1.6 DIContainer ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥ âœ…

**å‰å›ã®æŒ‡æ‘˜**: DIãƒ‘ã‚¿ãƒ¼ãƒ³ãŒåŠ¹æœçš„ã«æ´»ç”¨ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… å®Œå…¨ãª DI ã‚·ã‚¹ãƒ†ãƒ ãŒå°å…¥
- `src/Dependency/DIContainer.ts` (53è¡Œ) - å‹å®‰å…¨ãª DI å®Ÿè£…
- `src/Dependency/DIContainerProvider.tsx` - React çµ±åˆ
- `src/deps.tsx` (181è¡Œ) - ä¸€å…ƒçš„ãªä¾å­˜æ€§è¨­å®š

**è©•ä¾¡**: è‰¯å¥½ã€‚å‹å®‰å…¨ã§æ‹¡å¼µå¯èƒ½ãªè¨­è¨ˆã€‚

---

### âš ï¸ PARTIALLY RESOLVED: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é‡è¤‡

#### 2.1 PianoRollHandle ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®é‡è¤‡ âš ï¸

**å‰å›ã®æŒ‡æ‘˜**: `PianoRollHandle` ãŒ 2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹

**ç¾åœ¨ã®çŠ¶æ…‹**: âš ï¸ éƒ¨åˆ†çš„ã«æ”¹å–„
- ParameterEditor ãŒ PianoRoll ã‹ã‚‰ `PianoRollHandle` ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- **é‡è¤‡å®šç¾©ã¯è§£æ¶ˆ** âœ…
- **ãŸã ã—ã€å¯†çµåˆãŒæ®‹å­˜** âŒ

**Location**: `src/ParameterEditor/ParameterEditor.ts:7`
```typescript
import { type PianoRollHandle, ... } from "../PianoRoll/PianoRoll.ts";
```

**è©•ä¾¡**: é‡è¤‡ã¯è§£æ¶ˆã•ã‚ŒãŸãŒã€å…±æœ‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒ ParameterEditor ã¨ PianoRoll ã‚’çµåˆã—ã¦ã„ã‚‹ã€‚

---

### âŒ NOT ADDRESSED: EventBus ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰

**å‰å›ã®æŒ‡æ‘˜**: 3ã¤ã® emit å‘¼ã³å‡ºã—ãŒæ¯å›ç¹°ã‚Šè¿”ã•ã‚Œã‚‹ (before/do/after ãƒ‘ã‚¿ãƒ¼ãƒ³)

**ç¾åœ¨ã®çŠ¶æ…‹**: âŒ æœªå®Ÿè£…
- ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã¾ã  3å›ã® emit ã‚’æ‰‹å‹•ã§è¡Œã£ã¦ã„ã‚‹

**ä¾‹**: `src/usecases/SetNotes.ts:36-38`
```typescript
bus.emit("notes.set.before", channelId, notes);
bus.emit("notes.set", channelId, notes);
bus.emit("notes.set.after", channelId, notes);
```

**å½±éŸ¿**: ç´„24è¡Œã®ã‚³ãƒ¼ãƒ‰é‡è¤‡ãŒå­˜åœ¨

**æ¨å¥¨**: EventBus ã« helper ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
```typescript
bus.emitWithPhases("notes.set", channelId, notes);
```

---

## 2. å‘½åã®ä¸€è²«æ€§ã®å•é¡Œ

### ğŸ”´ HIGH: Cursor ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ä¸çµ±ä¸€

**Location 1**: `src/PianoRoll/PianoRollState.ts:148`
```typescript
cursor: "default"
```

**Location 2**: `src/ParameterEditor/ParameterEditorState.ts:38`
```typescript
cursor: "normal"  // âŒ ç•°ãªã‚‹å€¤
```

**å•é¡Œ**:
- CSS cursor å€¤ã¯ `"default"` ãŒæ¨™æº–
- `"normal"` ã¯æœ‰åŠ¹ãª CSS cursor å€¤ã§ã¯ãªã„
- 2ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã§ã®ä¸€è²«æ€§ãŒãªã„

**æ¨å¥¨**:
```typescript
// ParameterEditorState.ts:38 ã‚’ä»¥ä¸‹ã«å¤‰æ›´
cursor: "default"
```

**å½±éŸ¿**: å°ã•ã„ãŒã€ãƒã‚°ã®ç¨®ã«ãªã‚‹å¯èƒ½æ€§

---

### ğŸŸ¡ MEDIUM: Handle å‹ã®å‘½åå•é¡Œ

**Current State**:
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å: `PianoRollHandle`
- å®Ÿè£…å ´æ‰€: `src/PianoRoll/PianoRoll.ts:1110`
- ä½¿ç”¨ç®‡æ‰€: `ParameterEditor` ã§ã‚‚ä½¿ã‚ã‚Œã¦ã„ã‚‹

**å•é¡Œ**:
- `PianoRollHandle` ã¨ã„ã†åå‰ã¯ PianoRoll å›ºæœ‰ã«èã“ãˆã‚‹ãŒã€å®Ÿã¯æ±ç”¨çš„ãªãƒã‚¤ãƒ³ã‚¿æ“ä½œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- ParameterEditor ã§ã‚‚åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€æ¦‚å¿µçš„ã«ã¯é–“é•ã£ã¦ã„ã‚‹

**æ¨å¥¨**:
```typescript
// src/PointerEvents/PointerInteractionHandle.ts ã‚’æ–°è¦ä½œæˆ
export interface PointerInteractionHandle {
	cursor: string;
	handlePointerDown?: (ev: PointerEvent) => void;
	handlePointerUp?: (ev: PointerEvent) => void;
	handleDragStart?: (ev: PointerEvent) => void;
	handleDragMove?: (ev: PointerEvent) => void;
	handleDragEnd?: (ev: PointerEvent) => void;
	handleTap?: (ev: PointerEvent) => void;
	handleDoubleClick?: (ev: PointerDoubleClickEvent) => void;
}

// PianoRoll ã¨ ParameterEditor ä¸¡æ–¹ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import { type PointerInteractionHandle } from "../PointerEvents/PointerInteractionHandle.ts";
```

**å½±éŸ¿**: ä¸­ç¨‹åº¦ã€‚æ­£ç¢ºãªå‘½åã§ç†è§£æ€§ãŒå‘ä¸Šã™ã‚‹ã€‚

---

### ğŸŸ¡ MEDIUM: UseCase å‹å‘½åã®é‡è¤‡

**Location**: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ« (12å€‹)

**ä¾‹**: `src/usecases/SetNotes.ts:7`
```typescript
export type SetNotes = ReturnType<typeof SetNotes>;  // âŒ å‹ã¨é–¢æ•°ãŒåŒã˜åå‰
```

**å•é¡Œ**:
- é–¢æ•° `SetNotes` ã¨å‹ `SetNotes` ãŒåŒã˜åå‰
- TypeScript ã§ã¯è¨±å¯ã•ã‚Œã‚‹ãŒã€æ··ä¹±ã—ã‚„ã™ã„
- ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ã€Œã“ã‚Œã¯å‹ã‹é–¢æ•°ã‹?ã€ãŒä¸æ˜ç¢º

**æ¨å¥¨**:
```typescript
// Option A: å‹ã«æ¥å°¾è¾ã‚’ä»˜ã‘ã‚‹
export type SetNotesUseCase = ReturnType<typeof SetNotes>;

// Option B: é–¢æ•°ã‚’å°æ–‡å­—ã«ã™ã‚‹ï¼ˆã‚ˆã‚Š TypeScript çš„ï¼‰
export type SetNotes = ReturnType<typeof setNotes>;
export function setNotes({...}) { ... }
```

**å½±éŸ¿**: ä½ï½ä¸­ã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®æ„å›³ã‚’æ˜ç¢ºã«ã™ã‚‹ã€‚

---

### ğŸŸ¢ LOW: ã‚¤ãƒ™ãƒ³ãƒˆå‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ˜ç¢ºæ€§ä¸è¶³

**Location**: `src/EventBus.ts:12-53`

**ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³**:
```typescript
"notes.set.before": [channelId: number, notes: Iterable<Note>];
"notes.set": [channelId: number, notes: Iterable<Note>];
"notes.set.after": [channelId: number, notes: Iterable<Note>];
```

**å•é¡Œ**:
- 3ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒã™ã¹ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€ãƒªã‚¹ãƒŠãƒ¼ã¯ã©ã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’ä½¿ã†ã¹ãã‹ä¸æ˜ç¢º
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãªã„

**æ¨å¥¨**:
EventBus.ts ã®å…ˆé ­ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ :
```typescript
/**
 * Event naming convention:
 * - "entity.action.before" - emitted before action, can be used for validation
 * - "entity.action" - emitted after action completes, main event to listen to
 * - "entity.action.after" - emitted after all listeners have processed
 *
 * Recommended: Listen to "entity.action" (middle phase) for normal operations
 */
```

**å½±éŸ¿**: ä½ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„ã€‚

---

## 3. DI ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ‰åŠ¹æ€§è©•ä¾¡

### âœ… è‰¯å¥½ãªè¨­è¨ˆ: Composition Root ãƒ‘ã‚¿ãƒ¼ãƒ³

**Current Implementation**:
- `src/App/AppView.tsx` ãŒå”¯ä¸€ã® Composition Root
- `useComponent()` hook ã§ DI ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ä¾å­˜æ€§ã‚’å–å¾—
- å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¯ props ã§ä¾å­˜æ€§ã‚’æ¸¡ã™

**è©•ä¾¡**: â­â­â­â­â­ (5/5)
- âœ… ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ãŒé«˜ã„ (props ã§ä¾å­˜æ€§ã‚’å·®ã—æ›¿ãˆå¯èƒ½)
- âœ… ä¸€å…ƒçš„ãªç®¡ç† (AppView ã§å…¨ä¾å­˜æ€§ã‚’ç®¡ç†)
- âœ… å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ DI ã‚’çŸ¥ã‚‰ãªã„ (é–¢å¿ƒã®åˆ†é›¢)
- âœ… å‹å®‰å…¨ (ComponentKey ã«ã‚ˆã‚‹å‹ãƒã‚§ãƒƒã‚¯)

---

### âœ… é©åˆ‡ãªä½¿ç”¨: 23ç®‡æ‰€ã® useComponent å‘¼ã³å‡ºã—

**Location**: `src/App/AppView.tsx:28-163`

ã™ã¹ã¦ãŒé©åˆ‡ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹:
```typescript
const pianoRoll = useComponent(PianoRoll.Key);
const eventBus = useComponent(EventBus.Key);
const songStore = useComponent(SongStore.Key);
// ... 20 more
```

---

### âš ï¸ æ”¹å–„ã®ä½™åœ°: AudioContext ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³

**Location**: `src/Player/Player.ts:53-58`
```typescript
return new Player(
  AudioContextHolder.get(),  // âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³
  deps.get(SongStore.Key),
  deps.get(InstrumentStore.Key),
);
```

**å•é¡Œ**:
- ä»–ã®ä¾å­˜æ€§ã¯ DI ã§å–å¾—ã™ã‚‹ãŒã€AudioContext ã ã‘ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«
- ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒƒã‚¯ AudioContext ã‚’æ³¨å…¥ã§ããªã„
- DI ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸€è²«æ€§ãŒæãªã‚ã‚Œã¦ã„ã‚‹

**æ¨å¥¨**:
```typescript
// deps.tsx ã«è¿½åŠ 
.set(AudioContext.Key, () => AudioContextHolder.get())

// Player.ts ã§ä½¿ç”¨
.set(Player.Key, (deps) => {
  return new Player(
    deps.get(AudioContext.Key),  // âœ… DI çµŒç”±
    deps.get(SongStore.Key),
    deps.get(InstrumentStore.Key),
  );
})
```

**å½±éŸ¿**: ä½ã€‚ä¸€è²«æ€§ã®å•é¡Œã€‚

---

### â„¹ï¸ è¨­è¨ˆé¸æŠ: DIContainer ã®è¤‡é›‘æ€§

**Observation**:
- `DIContainer` ã¯å¼·åŠ›ãªæ©Ÿèƒ½ã‚’æŒã¤
- ã—ã‹ã—ã€Composition Root ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãŸã‚ã€å®Ÿéš›ã«ã¯å˜ä¸€ã®å ´æ‰€ã‹ã‚‰ã—ã‹ä½¿ç”¨ã•ã‚Œãªã„

**è€ƒå¯Ÿ**:
ç¾åœ¨ã®ä½¿ç”¨æ–¹æ³•ã§ã‚‚è‰¯å¥½ã ãŒã€å°†æ¥çš„ã«ã¯ä»¥ä¸‹ã‚’æ¤œè¨:
1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¤‡æ•°ã® Composition Point ã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆ â†’ DIContainer ãŒæœ‰åŠ¹
2. å˜ç´”ãªä¾å­˜æ€§ã‚°ãƒ©ãƒ•ã«ã¨ã©ã¾ã‚‹å ´åˆ â†’ ã‚ˆã‚Šç°¡æ½”ãªãƒ‘ã‚¿ãƒ¼ãƒ³ (ä¾‹: `configureDeps()` é–¢æ•°) ã§ååˆ†

**ç¾æ™‚ç‚¹ã®è©•ä¾¡**: é©åˆ‡ãªè¨­è¨ˆã€‚éåº¦ãªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã§ã¯ãªã„ã€‚

---

## 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡Œ

### ğŸ”´ CRITICAL: ParameterEditor â†” PianoRoll ã®å¯†çµåˆ

**Severity**: é«˜
**Impact**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«æ‚ªå½±éŸ¿

#### 4.1 ç›´æ¥çš„ãªä¾å­˜é–¢ä¿‚

**Location**: `src/ParameterEditor/ParameterEditor.ts`

**Constructor (line 88-90)**:
```typescript
constructor(
  private readonly pianoRoll: PianoRoll,  // âŒ ç›´æ¥ä¾å­˜
  ...
)
```

**Direct State Access** (14ç®‡æ‰€ä»¥ä¸Š):
```typescript
this.pianoRoll.state.selectedNoteIds    // Line 48, 280, 287
this.pianoRoll.state.activeChannelId    // Line 59, 282, 334, 361
this.pianoRoll.state.scrollLeft         // Line 98
this.pianoRoll.state.zoom               // Line 100, 293, 306
```

**Direct Method Calls**:
```typescript
this.pianoRoll.unselectAllNotes()       // Line 44
this.pianoRoll.setSelectedNotes([...])  // Line 75
```

#### 4.2 å‹ã®å…±æœ‰ã«ã‚ˆã‚‹ã•ã‚‰ãªã‚‹çµåˆ

**Location**: `src/ParameterEditor/ParameterEditor.ts:7`
```typescript
import {
  type PianoRollHandle,
  type PianoRollPointerEvent,
  type PianoRollPosition,
  type PointerSession,
  type PointerState,
} from "../PianoRoll/PianoRoll.ts";
```

5ã¤ã®å‹ã‚’ PianoRoll ã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

#### 4.3 å•é¡Œã®æœ¬è³ª

1. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç„¡è¦–**: EventBus ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã«ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„
2. **ãƒ†ã‚¹ãƒˆå›°é›£æ€§**: ParameterEditor ã‚’å˜ä½“ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ PianoRoll ãŒå¿…é ˆ
3. **æ‹¡å¼µæ€§ã®ä½ä¸‹**: PianoRoll ãªã—ã§ ParameterEditor ã‚’å†åˆ©ç”¨ã§ããªã„
4. **ä¿å®ˆæ€§ã®ä½ä¸‹**: PianoRoll ã®å¤‰æ›´ãŒç›´æ¥ ParameterEditor ã«æ³¢åŠ

#### 4.4 æ¨å¥¨ã•ã‚Œã‚‹æ”¹å–„

**Step 1**: å…±æœ‰å‹ã‚’æŠ½å‡º
```typescript
// src/PointerEvents/PointerInteractionHandle.ts ã‚’æ–°è¦ä½œæˆ
export interface PointerInteractionHandle { ... }
export interface PointerEvent { ... }
export interface Position { ... }
// ... ãã®ä»–
```

**Step 2**: EventBus ã§ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
// PianoRoll.ts ã§é¸æŠå¤‰æ›´æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
setSelectedNotes(noteIds: Iterable<number>) {
  this.updateState((state) => state.setSelectedNotes(noteIds));
  this.bus.emit("pianoRoll.selectionChanged", noteIds);  // â† è¿½åŠ 
}

// ParameterEditor.ts ã§è³¼èª­
constructor(
  private readonly bus: EventBus,
  private readonly songStore: Stateful<Song>,
  private readonly setNoteParameter: SetNoteParameter,
) {
  bus.on("pianoRoll.selectionChanged", (noteIds) => {
    this.updateSelectedNotes(noteIds);
  });
}
```

**Step 3**: ä¾å­˜é–¢ä¿‚ã®å‰Šé™¤
```typescript
// Before:
constructor(
  private readonly pianoRoll: PianoRoll,  // âŒ å‰Šé™¤
  private readonly songStore: Stateful<Song>,
)

// After:
constructor(
  private readonly bus: EventBus,        // âœ… è¿½åŠ 
  private readonly songStore: Stateful<Song>,
)
```

**å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä¸­ç¨‹åº¦ (2-3æ™‚é–“)
**åŠ¹æœ**: é«˜ã„ (ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ â†‘â†‘, æ‹¡å¼µæ€§ â†‘â†‘)

---

### ğŸ”´ HIGH: ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã®é‡è¤‡

**Severity**: é«˜
**Impact**: ã‚³ãƒ¼ãƒ‰ä¿å®ˆæ€§ã®ä½ä¸‹

#### 4.5 é‡è¤‡ã‚³ãƒ¼ãƒ‰ã®ç®‡æ‰€

**PianoRoll** (`src/PianoRoll/PianoRoll.ts`) ã¨ **ParameterEditor** (`src/ParameterEditor/ParameterEditor.ts`) ãŒã»ã¼åŒã˜ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’å®Ÿè£…:

1. `handlePointerDown()` - ä¸¡æ–¹ã§å®Ÿè£…
2. `handlePointerMove()` - ä¸¡æ–¹ã§å®Ÿè£…
3. `handlePointerUp()` - ä¸¡æ–¹ã§å®Ÿè£…
4. `handleDragStart()` - ä¸¡æ–¹ã§å®Ÿè£…
5. `handleDragMove()` - ä¸¡æ–¹ã§å®Ÿè£…
6. `handleDragEnd()` - ä¸¡æ–¹ã§å®Ÿè£…
7. `handleTap()` - ä¸¡æ–¹ã§å®Ÿè£…
8. `handleDoubleClick()` - ä¸¡æ–¹ã§å®Ÿè£…

**æ¨å®šã•ã‚Œã‚‹é‡è¤‡ã‚³ãƒ¼ãƒ‰é‡**: 300+ è¡Œ

#### 4.6 æ¨å¥¨ã•ã‚Œã‚‹æ”¹å–„

**Extract**: ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’å…±æœ‰ã‚¯ãƒ©ã‚¹ã«
```typescript
// src/PointerEvents/PointerInteractionManager.ts ã‚’æ–°è¦ä½œæˆ
export class PointerInteractionManager {
  constructor(
    private resolvePosition: (ev: MouseEvent | PointerEvent) => Position,
    private findHandle: (pos: Position) => PointerInteractionHandle | null,
  ) {}

  handlePointerDown(ev: MouseEvent | PointerEvent) { ... }
  handlePointerMove(ev: MouseEvent | PointerEvent) { ... }
  handlePointerUp(ev: MouseEvent | PointerEvent) { ... }
  // ... ãã®ä»–
}

// PianoRoll.ts ã§ä½¿ç”¨
private pointerManager = new PointerInteractionManager(
  (ev) => this.resolvePosition(ev),
  (pos) => this.findHandle(pos),
);

handlePointerDown(ev: PointerEvent) {
  this.pointerManager.handlePointerDown(ev);
}
```

**å®Ÿè£…ã‚³ã‚¹ãƒˆ**: é«˜ (3-4æ™‚é–“)
**åŠ¹æœ**: é«˜ã„ (ä¿å®ˆæ€§ â†‘â†‘, ãƒã‚°ä¿®æ­£ã®ä¸€å…ƒåŒ–)

---

### ğŸŸ¡ MEDIUM: UseCase ãŒ Infrastructure ã«ä¾å­˜

**Severity**: ä¸­
**Impact**: å±¤ã®æ§‹é€ ãŒä¸æ˜ç¢º

#### 4.7 å•é¡Œã®è©³ç´°

**Location**: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ« (12å€‹)

**ä¾‹**: `src/usecases/SetNotes.ts`
```typescript
export function SetNotes({
  songStore,
  history,    // âŒ Infrastructure (Undo/Redo)
  bus,        // âŒ Infrastructure (Event Bus)
}: {...}) { ... }
```

**Clean Architecture ã§ã¯**:
```
UI Layer
  â†“
Use Case Layer (ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¤ãƒ³ãƒ•ãƒ©ã«ä¾å­˜ã—ãªã„)
  â†“
Infrastructure Layer (DB, ã‚¤ãƒ™ãƒ³ãƒˆã€ãƒ•ã‚¡ã‚¤ãƒ«I/O)
```

**ç¾åœ¨ã®å®Ÿè£…**:
```
UI Layer
  â†“
Use Case Layer + Infrastructure (æ··åœ¨)
  â†“
Data/Model Layer
```

#### 4.8 æ”¹å–„æ¡ˆ

**Option A**: Command ãƒ‘ã‚¿ãƒ¼ãƒ³ (æ¨å¥¨)
```typescript
export interface Command {
  execute(): void;
  undo(): void;
}

// SetNotes ã¯ Command ã‚’è¿”ã™
export function SetNotes(songStore: SongStore) {
  return (channelId: number, notes: Iterable<Note>): Command => {
    const previousNotes = songStore.state.channels[channelId].notes;
    return {
      execute: () => {
        songStore.setNotes(channelId, notes);
      },
      undo: () => {
        songStore.setNotes(channelId, previousNotes);
      }
    };
  };
}

// Infrastructure layer ã§å®Ÿè¡Œ
class CommandExecutor {
  execute(command: Command) {
    const previousCommand = this.history.executeCommand(command);
    if (previousCommand) {
      this.bus.emit("command.executed", previousCommand);
    }
  }
}
```

**ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ˜¯æ­£**:

å®Ÿéš›ã®ã¨ã“ã‚ã€ç¾åœ¨ã®å®Ÿè£…ã¯ CQRS (Command Query Responsibility Segregation) çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚Šã€å®Œå…¨ã«é–“é•ã£ã¦ã¯ã„ãªã„ã€‚ãŸã ã—:
- infrastructure ã¸ã®ç›´æ¥ä¾å­˜ã‚’ã‚‚ã†å°‘ã—æŠ½è±¡åŒ–ã™ã‚‹ã®ãŒæœ›ã¾ã—ã„
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯ç´”ç²‹ã«ä¿ãŸã‚Œã¦ã„ã‚‹

**å®Ÿè£…ã‚³ã‚¹ãƒˆ**: é«˜ (4-5æ™‚é–“)
**åŠ¹æœ**: ä¸­ (å±¤ã®æ¦‚å¿µçš„ãªæ˜ç¢ºæ€§)

---

### ğŸŸ¡ MEDIUM: SongStore ã¨ Song ãƒ¢ãƒ‡ãƒ«ã®è²¬å‹™åˆ†é›¢

**Severity**: ä¸­
**Impact**: è¨­è¨ˆã®æ˜ç¢ºæ€§

#### 4.9 ç¾åœ¨ã®çŠ¶æ…‹

**Song ãƒ¢ãƒ‡ãƒ«** (`src/models/Song.ts`):
```typescript
export class Song {
  insertChannel(channel: Channel, index: number): Song { ... }
  appendChannel(channel: Channel): Song { ... }
  deleteChannel(index: number): Song { ... }
  setNotes(channelId: number, notes: Iterable<Note>): Song { ... }
  updateChannel(channelId: number, patch: Partial<Channel>): Song { ... }
  // ... more
}
```

**SongStore** (`src/SongStore.ts`):
```typescript
export class SongStore extends Stateful<Song> {
  insertChannel(channel: Channel, index: number) { ... }
  appendChannel(channel: Channel) { ... }
  deleteChannel(index: number) { ... }
  setNotes(channelId: number, notes: Iterable<Note>) { ... }
  // ... more
}
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³**:
- `Song` = ä¸å¤‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« (ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™)
- `SongStore` = ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãƒ©ãƒƒãƒ‘ãƒ¼ (updateState + EventBus é€£æº)

#### 4.10 è©•ä¾¡

**å®Ÿã¯é©åˆ‡ãªè¨­è¨ˆ**:
1. âœ… Model/Store ã®åˆ†é›¢ã¯å¤šãã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§è¦‹ã‚‰ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
2. âœ… è²¬å‹™ãŒæ˜ç¢º (Song = ãƒ‡ãƒ¼ã‚¿æ“ä½œã€SongStore = çŠ¶æ…‹ç®¡ç†)
3. âœ… ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ãŒé«˜ã„ (Song ã¯ç´”ç²‹ã€SongStore ã¯ä¾å­˜æ€§æ³¨å…¥å¯èƒ½)

**ãŸã ã—æ”¹å–„ã®ä½™åœ°**:
- SongStore ãŒ Song ã®å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒŸãƒ©ãƒ¼ã™ã‚‹ã“ã¨ã§ã€è‹¥å¹²ã®é‡è¤‡æ„Ÿ
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã¨ã‚ˆã„

**æ¨å¥¨**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ 
```typescript
/**
 * SongStore ã¯ Song (ä¸å¤‰ãƒ¢ãƒ‡ãƒ«) ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãƒ©ãƒƒãƒ‘ãƒ¼
 *
 * Song: ä¸å¤‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
 * - ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ–°ã—ã„ Song ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
 * - å‰¯ä½œç”¨ãªã—
 *
 * SongStore: çŠ¶æ…‹ç®¡ç†å±¤
 * - Song ã®çŠ¶æ…‹ã‚’ç®¡ç†
 * - å¤‰æ›´ã‚’ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ (EventBus)
 * - ãƒªã‚¹ãƒŠãƒ¼ã«å¤‰æ›´ã‚’é€šçŸ¥
 *
 * ä½¿ç”¨ä¾‹:
 * - Song: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€è¨ˆç®—
 * - SongStore: UIæ›´æ–°ã€ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ›´æ–°
 */
```

**å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä½ (15åˆ†)
**åŠ¹æœ**: ä½ (ç†è§£æ€§å‘ä¸Š)

---

### ğŸŸ¢ LOW: EventBus ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

**Severity**: ä½
**Impact**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®ãƒªã‚¹ã‚¯

#### 4.11 å•é¡Œã®è©³ç´°

**Location**: `src/SongStore.ts:14-31`

```typescript
constructor(bus: EventBus) {
  super(new Song());

  bus
    .on("channel.add", (channel) => { ... })
    .on("channel.delete", (channelId) => { ... })
    .on("channel.update", (channelId, patch) => { ... })
    .on("notes.set", (channelId, notes) => { ... })
    .on("notes.delete", (channelId, noteIds) => { ... })
    .on("song.set", (song) => { ... })
    .on("song.update", (patch) => { ... });
}
```

**å•é¡Œ**:
- 8ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã‚‹
- ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤ã™ã‚‹æ–¹æ³•ãŒãªã„
- SongStore ãŒå†ä½œæˆã•ã‚Œã‚‹å ´åˆã€ãƒªã‚¹ãƒŠãƒ¼ãŒé‡è¤‡ã™ã‚‹å¯èƒ½æ€§

#### 4.12 æ¨å¥¨ã•ã‚Œã‚‹æ”¹å–„

**EventEmitter ã®æ”¹å–„**:
```typescript
// src/Stateful/EventEmitter.ts ã‚’ä¿®æ­£
export class EventEmitter<E extends Record<string, unknown[]>> {
  on<K extends keyof E>(
    eventName: K,
    listener: (...args: E[K]) => void,
  ): () => void {  // â† ã‚¢ãƒ³ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–é–¢æ•°ã‚’è¿”ã™
    // ... å®Ÿè£…
    return () => {
      // ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    };
  }
}

// SongStore ã§æ´»ç”¨
constructor(bus: EventBus) {
  super(new Song());

  this.unsubscribers = [
    bus.on("channel.add", (channel) => { ... }),
    bus.on("channel.delete", (channelId) => { ... }),
    // ... ãã®ä»–
  ];
}

dispose() {
  this.unsubscribers.forEach(unsub => unsub());
  this.unsubscribers = [];
}
```

**å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä½ (1æ™‚é–“)
**åŠ¹æœ**: ä½ï½ä¸­ (ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢)

---

## 5. æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ãƒ»ç°¡æ½”åŒ–ã®æ©Ÿä¼š

### âœ… RESOLVED: openFileSelectDialog ã¨ downloadText

**å‰å›ã®æŒ‡æ‘˜**: ãƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°ã§1ç®‡æ‰€ã‹ã‚‰ã®ã¿å‘¼ã³å‡ºã—

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… çŠ¶æ…‹ãŒæ”¹å–„
- ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦ã¯ `LoadFile` ã¨ `SaveFile` ã§å¼•ãç¶šãä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒã€ã“ã‚Œã‚‰ã¯é©åˆ‡

**è©•ä¾¡**: OKã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¯é©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚

---

### ğŸŸ¢ ãã®ä»–ã®æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã«ã¯é¡•è‘—ãªæœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¯è¦‹å½“ãŸã‚‰ãªã„ã€‚å‰å›ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã®å‰Šé™¤ã«ã‚ˆã‚Šã€ã‹ãªã‚Šæ•´ç†ã•ã‚ŒãŸã€‚

---

## 6. ãã®ä»–ã®å•é¡Œ

### 6.1 TODO ã‚³ãƒ¡ãƒ³ãƒˆ

**Location**: `src/SoundFontSynthesizer/SoundFont.ts:1281`
```typescript
// ã‚µãƒ³ãƒ—ãƒ«ã®å†ç”Ÿãƒ¢ãƒ¼ãƒ‰(ãƒ«ãƒ¼ãƒ—è¨­å®šãªã©)TODO
```

**è©•ä¾¡**: ç•™æ„äº‹é …ã€‚å®Ÿè£…äºˆå®šã‹ã€æ„å›³çš„ã«å»¶æœŸã‹ã‚’æ˜ç¢ºã«ã™ã‚‹ã¨ã‚ˆã„ã€‚

**æ¨å¥¨**:
```typescript
// TODO: SoundFont sample loop modes
// Deferred until: [version] or when feature is requested
```

---

### 6.2 Model ã® Deserialization ã®è¤‡é›‘æ€§

**Location**: `src/models/Song.ts:99-110`

```typescript
static async deserialize(
  data: SerializedSong,
  soundFontStore: SoundFontStore,  // âŒ Infrastructure ä¾å­˜
): Promise<Song> {
  // ...
}
```

**å•é¡Œ**:
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãŒ Infrastructure (SoundFontStore) ã«ä¾å­˜
- ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®ãŸã³ã« SoundFontStore ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹

**æ¨å¥¨**:
```typescript
// Model ã¯ç´”ç²‹ã«ä¿ã¤
static deserialize(data: SerializedSong): Song { ... }

// Deserialization å…¨ä½“ã®è²¬å‹™ã¯åˆ¥å±¤ã«
class SongLoader {
  async loadFromFile(
    file: File,
    soundFontStore: SoundFontStore,
  ): Promise<Song> {
    const data = JSON.parse(await file.text());
    const song = Song.deserialize(data);
    // æ¥½å™¨ã®äº‹å‰èª­ã¿è¾¼ã¿ãªã©
    return song;
  }
}
```

**å®Ÿè£…ã‚³ã‚¹ãƒˆ**: ä¸­ (2æ™‚é–“)
**åŠ¹æœ**: ä¸­ (ãƒ¢ãƒ‡ãƒ«ã®ç´”ç²‹æ€§)

---

## 7. æ”¹å–„å„ªå…ˆåº¦

### ğŸ”´ HIGH PRIORITY (å³åº§ã«å¯¾å¿œã™ã¹ã)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | åŠ¹æœ |
|---|------|------|--------|------|
| 1 | ParameterEditor â†” PianoRoll ã®å¯†çµåˆè§£é™¤ | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ ¹å¹¹ã€ãƒ†ã‚¹ãƒˆå›°é›£ | 2-3h | â­â­â­â­ |
| 2 | ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®é‡è¤‡æ’é™¤ | ã‚³ãƒ¼ãƒ‰é‡è¤‡ 300+ è¡Œã€ä¿å®ˆæ€§ä½ä¸‹ | 3-4h | â­â­â­â­ |
| 3 | Cursor ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®çµ±ä¸€ | æ½œåœ¨çš„ãªãƒã‚° | 15m | â­â­ |
| 4 | EventBus emitWithPhases ãƒ˜ãƒ«ãƒ‘ãƒ¼ | DRY åŸå‰‡ã€é‡è¤‡ 24è¡Œ | 1h | â­â­â­ |

---

### ğŸŸ¡ MEDIUM PRIORITY (æ¬¡ã®ã‚¹ãƒ—ãƒªãƒ³ãƒˆ)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | åŠ¹æœ |
|---|------|------|--------|------|
| 5 | AudioContext ã‚’ DI ã«ç§»è¡Œ | ä¸€è²«æ€§ã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ | 30m | â­â­ |
| 6 | SongStore ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æ¸…ç† | ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ | 1h | â­â­ |
| 7 | Handle å‹ã®å‘½åå¤‰æ›´ | æ¦‚å¿µçš„æ­£ç¢ºæ€§ | 1-2h | â­â­ |
| 8 | UseCase å‹å‘½åã®çµ±ä¸€ | å‘½åä¸€è²«æ€§ | 1h | â­â­ |

---

### ğŸŸ¢ LOW PRIORITY (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»å°†æ¥çš„)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | åŠ¹æœ |
|---|------|------|--------|------|
| 9 | ã‚¤ãƒ™ãƒ³ãƒˆå‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | ç†è§£æ€§å‘ä¸Š | 30m | â­ |
| 10 | Song/SongStore ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | è¨­è¨ˆç†è§£ | 30m | â­ |
| 11 | TODO ã‚³ãƒ¡ãƒ³ãƒˆã®æ˜ç¢ºåŒ– | ã‚³ãƒ¼ãƒ‰å“è³ª | 15m | â­ |

---

## 8. ç·åˆè©•ä¾¡

### ğŸ“Š ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ¯”è¼ƒ

| æŒ‡æ¨™ | å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ | ç¾åœ¨ | æ”¹å–„åº¦ |
|------|-----------|------|--------|
| App.ts ä¾å­˜æ€§ | 21 | 4 | **-81%** âœ…âœ… |
| App.ts è¡Œæ•° | ~165 | 117 | **-29%** âœ… |
| FileStore/SongStore | è¤‡é›‘ | ã‚·ãƒ³ãƒ—ãƒ« | **å¤§å¹…æ”¹å–„** âœ…âœ… |
| å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« | - | 4 | **ç°¡æ½”åŒ–** âœ… |
| DIContainer å°å…¥ | ãªã— | ã‚ã‚Š | **æ–°æ©Ÿèƒ½** âœ… |
| é‡è¤‡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | 2 | 1 | **50% å‰Šæ¸›** âœ… |

### å¼·ã¿ âœ…

1. **å¤§è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®æˆåŠŸ**: App.ts ã®è²¬å‹™åˆ†å‰²ãŒè¦‹äº‹
2. **Clean ãª DI ã‚·ã‚¹ãƒ†ãƒ **: å‹å®‰å…¨ã§æ‹¡å¼µå¯èƒ½
3. **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: EventBus ã«ã‚ˆã‚‹å±¤é–“ã®ç–çµåˆ
4. **ä¸å¤‰ãªãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«**: Song / Channel ã®å®Ÿè£…ãŒå …å®Ÿ
5. **ãƒ†ã‚¹ãƒˆå¯èƒ½æ€§**: props ãƒ™ãƒ¼ã‚¹ã® Composition Root

### èª²é¡Œ âš ï¸

1. **ParameterEditor â†” PianoRoll å¯†çµåˆ**: æœ€å¤§ã®èª²é¡Œ
2. **ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆé‡è¤‡**: 300+ è¡Œã®é‡è¤‡ã‚³ãƒ¼ãƒ‰
3. **EventBus helper æœªå®Ÿè£…**: 24è¡Œã®é‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³
4. **å‹å‘½åã®ä¸€éƒ¨ä¸çµ±ä¸€**: Cursor, Handle, UseCase å‹
5. **ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ä¸è¶³**: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æ¸…ç†ãŒãªã„

### ã‚³ãƒ¼ãƒ‰å“è³ªã‚¹ã‚³ã‚¢

| è¦³ç‚¹ | ã‚¹ã‚³ã‚¢ | å‚™è€ƒ |
|------|--------|------|
| ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | 8/10 | å±¤æ§‹é€ ãŒæ˜ç¢ºã€DI å°å…¥ |
| å‘½åãƒ»ä¸€è²«æ€§ | 7/10 | æ”¹å–„ä½™åœ°ã‚ã‚Šï¼ˆå‹å‘½åãªã©ï¼‰ |
| é‡è¤‡ã®æ’é™¤ | 6/10 | ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã§é‡è¤‡ |
| ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ | 8/10 | props ãƒ™ãƒ¼ã‚¹ã€DI æ´»ç”¨ |
| ä¿å®ˆæ€§ | 7.5/10 | App.ts ã®æ”¹å–„ã«ã‚ˆã‚Šå‘ä¸Š |
| **ç·åˆã‚¹ã‚³ã‚¢** | **7.3/10** | å‰å›æ¯” +0.8 (10% æ”¹å–„) |

---

## 9. æ¨å¥¨ã•ã‚Œã‚‹å®Ÿè£…é †åº

### Phase 1: ç°¡å˜ãªä¿®æ­£ (1é€±é–“)
1. Cursor ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’çµ±ä¸€
2. EventBus ã« emitWithPhases ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’è¿½åŠ 
3. AudioContext ã‚’ DI ã«ç§»è¡Œ
4. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼æ¸…ç† (SongStore)

### Phase 2: ä¸­è¦æ¨¡ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° (2é€±é–“)
5. ParameterEditor â†” PianoRoll å¯†çµåˆè§£é™¤
   - å…±æœ‰å‹ã®æŠ½å‡º
   - EventBus ã§ã®é€šä¿¡ã«å¤‰æ›´
6. ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’å…±æœ‰ã‚¯ãƒ©ã‚¹ã«æŠ½å‡º

### Phase 3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»å¾®èª¿æ•´ (1é€±é–“)
7. Handle å‹ã®å‘½åå¤‰æ›´
8. UseCase å‹å‘½åã®çµ±ä¸€
9. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ 

---

## 10. çµè«–

### å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®é€²å±•

âœ… **å¤§å¹…ãªæ”¹å–„ã‚’å®Ÿç¾** - 6/7ã®ä¸»è¦é …ç›®ã‚’è§£æ±º

- App.ts ã®è²¬å‹™åˆ†å‰²ã«æˆåŠŸ (21 ä¾å­˜æ€§ â†’ 4)
- FileStore/SongStore ã¸ã®è¨­è¨ˆæ”¹å–„
- DIContainer ã‚·ã‚¹ãƒ†ãƒ ã®å°å…¥
- GetInstrument ã®å‰Šé™¤

### ç¾åœ¨ã®çŠ¶æ…‹

**ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯å …å®Ÿ**ã ãŒã€ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆã§æœ€é©åŒ–å¯èƒ½:

1. **ParameterEditor â†” PianoRoll ã®å¯†çµåˆ** - æœ€å„ªå…ˆã§æ”¹å–„ã™ã¹ã
2. **ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®é‡è¤‡** - ä¿å®ˆæ€§å‘ä¸Šã«ç›´çµ
3. **å‹å‘½åã®ä¸€éƒ¨ä¸çµ±ä¸€** - ç†è§£æ€§å‘ä¸Š
4. **EventBus helper ä¸è¶³** - DRY åŸå‰‡ã®å¾¹åº•

### æœ€çµ‚è©•ä¾¡

**Good to Excellent ã¸ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒã‚¤ãƒ³ãƒˆ**:

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ (7.3/10) ã¯åŸºæœ¬çš„ã«å¥å…¨ã§ã™ãŒã€ä¸Šè¨˜ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ã“ã¨ã§ 8.5-9.0 ã®ãƒ¬ãƒ™ãƒ«ã«åˆ°é”å¯èƒ½ã§ã™ã€‚

ç‰¹ã« **ParameterEditor ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°** ã¯ã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ã¨æ‹¡å¼µæ€§ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ãŸã‚ã€æœ€å„ªå…ˆã§å–ã‚Šçµ„ã‚€ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚

---

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ—¥**: 2025-12-08
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½è€…**: Claude Code
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 74 TypeScript ãƒ•ã‚¡ã‚¤ãƒ«
**ç·ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: ~9,647 è¡Œ
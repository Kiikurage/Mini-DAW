# MIDIã‚¨ãƒ‡ã‚£ã‚¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ—¥**: 2025-12-12
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: `/src` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã€ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ `e14c2a7e03f30049cb6ec27e84fc411760bccdbd`
**å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: `3678d85f325572054b00fe76a01925ffcc34b47f` (2025-12-08 04:00)
**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡**: ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã®è‰¯ã•ã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã€æ‹¡å¼µå®¹æ˜“æ€§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹/å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€æ„Ÿã‚’é‡è¦–

---

## ğŸ“‹ ç›®æ¬¡

1. [å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³](#1-å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³)
2. [æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°åˆ†æ](#2-æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°åˆ†æ)
3. [æ–°è¦å®Ÿè£…ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©•ä¾¡](#3-æ–°è¦å®Ÿè£…ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©•ä¾¡)
4. [æ–°è¦ã«ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ](#4-æ–°è¦ã«ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ)
5. [æ”¹å–„å„ªå…ˆåº¦](#5-æ”¹å–„å„ªå…ˆåº¦)
6. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡](#6-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡)
7. [ç·åˆè©•ä¾¡](#7-ç·åˆè©•ä¾¡)
8. [å®Ÿè£…ææ¡ˆ](#8-å®Ÿè£…ææ¡ˆ)

---

## 1. å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³

### âœ… HIGH: EventBus emitWithPhases ãƒ˜ãƒ«ãƒ‘ãƒ¼ - **å®Ÿè£…å®Œäº†**

**å‰å›ã®æŒ‡æ‘˜**: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ 3å›ã®æ‰‹å‹• emit å‘¼ã³å‡ºã—ï¼ˆ24è¡Œé‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ…âœ… å®Œå…¨ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

#### å®Ÿè£…ã®è©³ç´°

**EventBus.ts** (`src/EventBus.ts:67-74`):
```typescript
emitPhasedEvents<K extends keyof EventBusEventMap>(
    eventName: K,
    ...args: PhasedEvents<EventBusEventMap>[K]
): void {
    this.emit(`${eventName}.before` as K, ...args);
    this.emit(eventName, ...args);
    this.emit(`${eventName}.after` as K, ...args);
}
```

**å‹ã‚·ã‚¹ãƒ†ãƒ ã®æ”¹å–„**:
- `EventBusEventMap` ã‚’å®šç¾©ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆå‹ã‚’æ˜ç¤ºåŒ–
- `PhasedEvents<E>` mapped type ã§ `.before`, `.after` ã‚’è‡ªå‹•ç”Ÿæˆ
- å‹å®‰å…¨ã§ DRY ãªå®Ÿè£…

**ä½¿ç”¨çŠ¶æ³** (8ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§æ´»ç”¨):
- `SetSong.ts:26` â†’ `bus.emitPhasedEvents("song.set", song);`
- `UpdateSong.ts:37` â†’ `bus.emitPhasedEvents("song.update", patch);`
- `AddChannel.ts:21, 29` â†’ `bus.emitPhasedEvents("channel.add", channel);`
- `DeleteChannel.ts:28, 35` â†’ `bus.emitPhasedEvents("channel.delete", channelId);`
- `UpdateChannel.ts:24, 31` â†’ `bus.emitPhasedEvents("channel.update", ...);`
- `SetNotes.ts:36, 39, 40` â†’ `bus.emitPhasedEvents("notes.set/delete", ...);`
- `DeleteNotes.ts:23, 25` â†’ `bus.emitPhasedEvents("notes.delete/set", ...);`

**åŠ¹æœ**:
- ã‚³ãƒ¼ãƒ‰è¡Œæ•°å‰Šæ¸›: æ¨å®š 30+ è¡Œ
- å¯èª­æ€§å‘ä¸Š: `.before`, `.after` ã®æ¦‚å¿µãŒæ˜ç¢º
- é‡è¤‡ãƒ‘ã‚¿ãƒ¼ãƒ³æ’é™¤: DRY åŸå‰‡ã®å®Ÿç¾

**è©•ä¾¡ã‚¹ã‚³ã‚¢**: å‰å› 0/10ï¼ˆæœªå®Ÿè£…ï¼‰ â†’ **ç¾åœ¨ 10/10** âœ…âœ…

---

### âœ… MEDIUM: EventEmitter ã« unsubscribe æ©Ÿèƒ½ - **éƒ¨åˆ†å®Ÿè£…**

**å‰å›ã®æŒ‡æ‘˜**: EventBus ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§ãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²ã—ã¦ã„ã‚‹ãŒã€å‰Šé™¤æ–¹æ³•ãŒãªã„

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… éƒ¨åˆ†çš„ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

#### å®Ÿè£…çŠ¶æ³

**EventEmitter.ts ã® on() ãƒ¡ã‚½ãƒƒãƒ‰** (æ¨å®š):
```typescript
on<K extends keyof E>(
    eventName: K,
    listener: (...args: E[K]) => void,
): (() => void) | void {  // â† unsubscribeé–¢æ•°ã‚’è¿”ã™å¯èƒ½æ€§
    // ...
}
```

**å®Ÿè£…ç¢ºèª** (`src/react/ListBox/ListBox.tsx:99-107`):
```typescript
useEffect(() => {
    controller.on("change", onChangeListener);
    return () => {
        controller.off("change", onChangeListener);  // âœ… æ˜ç¤ºçš„å‰Šé™¤
    };
}, [controller]);
```

**ãŸã ã—å•é¡Œã‚ã‚Š** (`src/InstrumentStore.ts:41-57`):
```typescript
constructor(bus: EventBus) {
    super(new InstrumentStoreState());
    bus
        .on("song.set.after", (song) => { ... })  // âŒ å‰Šé™¤ã•ã‚Œãªã„
        .on("channel.add.after", (channel) => { ... })
        .on("channel.update.after", (channelId, patch) => { ... })
        // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®ãƒªã‚¹ã‚¯
}
```

**è©•ä¾¡**: âœ… æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ListBox, Select) ã§ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãŒã€æ—¢å­˜ã® Store ã§ã¯æœªå®Ÿè£…

**æ”¹å–„ä½™åœ°**: Store ã® `dispose()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ã‚’æ¨å¥¨

---

### âœ… MEDIUM: ActionRegistry - **å‰Šé™¤å®Œäº†**

**å‰å›ã®æŒ‡æ‘˜**: ActionRegistry ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒæœªçµ±åˆ

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… å®Œå…¨å‰Šé™¤

#### å‰Šé™¤ç†ç”±ã¨ç¾åœ¨ã®å®Ÿè£…

**å‰Šé™¤å†…å®¹**:
- ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤: `src/ActionRegistry/ActionRegistry.ts` (-16 è¡Œ)
- deps.tsx ã‹ã‚‰ã‚‚ç™»éŒ²å‰Šé™¤

**ä»£ã‚ã‚Šã®å®Ÿè£…æ–¹æ³•**:

1. **ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å‡¦ç†**: `KeyboardHandler.ts` ã§é›†ç´„
   ```typescript
   // KeyboardHandler.ts
   handleKeyDown(event: KeyboardEvent) {
       if (event.key === "Delete") {
           pianoRoll.deleteNotes();
       } else if (event.key === " ") {
           player.togglePlay();
       }
       // ... å¤šæ•°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
   }
   ```

2. **ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‡¦ç†**: `GlobalMenuBar.tsx` ã§ç›´æ¥å®Ÿè£…
   ```typescript
   // GlobalMenuBar.tsx
   onClickNewFile={() => newFile()}
   onClickOpen={() => loadFile()}
   onClickSave={() => saveFile()}
   ```

3. **ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å‡¦ç†**: `ToolBar.tsx`, `InstrumentSelect.tsx` ã§å€‹åˆ¥å®Ÿè£…

**è©•ä¾¡**: âœ… ActionRegistry ã®å‰Šé™¤ã«ã‚ˆã‚Šã€å‡¦ç†ãŒã‚ˆã‚Šç›´æ¥çš„ã§ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ãŸ

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**:
- âœ… ç›´æ„Ÿçš„ã§ã‚ã‹ã‚Šã‚„ã™ã„
- âœ… å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®èªçŸ¥è² è·å‰Šæ¸›
- âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å‚ç…§ã—ã«ãã„ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æ§‹é€ ãŒåˆ†æ•£ï¼‰

---

### âœ… CRITICAL: ParameterEditor â†” PianoRoll ã®å¯†çµåˆ - **ç¶­æŒ**

**å‰å›ã®çŠ¶æ…‹**: ã‚³ãƒŸãƒƒãƒˆ 3678d85 ã§å®Œå…¨è§£æ±º

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… è§£æ±ºçŠ¶æ…‹ãŒç¶­æŒã•ã‚Œã¦ã„ã‚‹

**å¤‰æ›´ãªã—**: 2ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯å¼•ãç¶šã Editor abstraction çµŒç”±ã§ç–çµåˆã‚’ä¿æŒ

---

### âš ï¸ MEDIUM: ParameterEditor ã¸ã® EventBus çµ±åˆ - **æœªå®Ÿè£…**

**å‰å›ã®æŒ‡æ‘˜**: ParameterEditor ãŒ EventBus ã‚’ç›´æ¥å—ã‘å–ã‚‰ãšã€Editor çµŒç”±ã®é€šä¿¡ã§ä¸€è²«æ€§ãŒã‚„ã‚„æ¬ ã‘ã‚‹

**ç¾åœ¨ã®çŠ¶æ…‹**: âš ï¸ æœªå®Ÿè£…ã®ã¾ã¾

**ç¾åœ¨ã®å®Ÿè£…** (`src/Editor/ParameterEditor/ParameterEditor.ts:36-42`):
```typescript
constructor(
    private readonly songStore: Stateful<Song>,
    private readonly setNoteStore: SetNoteParameter,
    private readonly editor: Editor,
) {
    // EventBus ã‚’å—ã‘å–ã‚‰ãªã„
}
```

**è©•ä¾¡**: ç¾åœ¨ã®è¨­è¨ˆã§ã‚‚æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€**å¯¾å¿œä¸è¦ã¨åˆ¤æ–­**ï¼ˆå‰å›ã®æ¨å¥¨ã‚’æ’¤å›ï¼‰

---

## 2. æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°åˆ†æ

### ã‚³ãƒŸãƒƒãƒˆ: "wip: Componentã‚’è¿½åŠ "

**å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 43 ãƒ•ã‚¡ã‚¤ãƒ«
**è¿½åŠ è¡Œæ•°**: 1887 è¡Œ
**å‰Šé™¤è¡Œæ•°**: 410 è¡Œ

#### ä¸»è¦ãªå¤‰æ›´

##### 2.1 æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (4å€‹)

1. **ListBox ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç³»** (207è¡Œ)
   - `src/react/ListBox/ListBox.tsx` - åŸºæœ¬ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
   - `src/react/ListBox/ListBoxController.tsx` - çŠ¶æ…‹ç®¡ç†
   - `src/react/ListBox/ListBoxState.ts` - ä¸å¤‰çŠ¶æ…‹å®šç¾©

2. **PopUp ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ** (148è¡Œ)
   - `src/react/Popup/PopUp.tsx` - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºç®¡ç†

3. **Select ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ** (225è¡Œ)
   - `src/react/Select/Select.tsx` - ListBox + PopUp ã®çµ„ã¿åˆã‚ã›

4. **InstrumentSelect ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ** (65è¡Œ)
   - `src/ToolBar/InstrumentSelect.tsx` - Select ã‚’ä½¿ç”¨ã—ãŸæ¥½å™¨é¸æŠ

##### 2.2 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»å‹•

- `src/react/ToolBar.tsx` â†’ `src/ToolBar/ToolBar.tsx`
- `src/App/KeyboardHandler.ts` â†’ `src/KeyboardHandler.ts`
- `src/react/OverlayManager.ts` â†’ `src/react/OverlayPortal.ts`

##### 2.3 å‰Šé™¤

- `src/ActionRegistry/ActionRegistry.ts` - æœªä½¿ç”¨ã®æŠ½è±¡åŒ–
- `src/react/ListBox.tsx` (æ—§ç‰ˆ)

##### 2.4 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¯¾è±¡

- `src/EventBus.ts` - PhasedEvents å‹ã«ã‚ˆã‚‹æ”¹å–„
- `src/Editor/Editor.ts` - EventBus å—ã‘å–ã‚Šè¿½åŠ 
- è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ - emitPhasedEvents ã®æ¡ç”¨

---

## 3. æ–°è¦å®Ÿè£…ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©•ä¾¡

### 3.1 ListBox / ListBoxController / ListBoxState

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/react/ListBox/`
**è¡Œæ•°**: ~350è¡Œ

#### è¨­è¨ˆå“è³ª

**âœ… å¼·ã¿**:
1. **ä¸å¤‰çŠ¶æ…‹ãƒ‘ã‚¿ãƒ¼ãƒ³**:
   ```typescript
   // ListBoxState.ts ã§ã¯æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
   setSelectedOptionId(optionId: string | null): ListBoxState {
       const option = this.options.find((option) => option.id === optionId) ?? null;
       if (option === null) return this;
       return new ListBoxState({ ...this, value: option.value });
   }
   ```

2. **Stateful ã®ç¶™æ‰¿**:
   - `Stateful<ListBoxState>` ã‚’æ‹¡å¼µã—ã¦ã€å¤‰æ›´é€šçŸ¥æ©Ÿæ§‹ã‚’ç²å¾—
   - `updateState()` ã«ã‚ˆã‚‹å‹å®‰å…¨ãªçŠ¶æ…‹æ›´æ–°

3. **ãƒ«ãƒ¼ãƒˆè¦ç´ ã¸ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹**:
   ```typescript
   // ListBox.tsx:24
   const rootRef = useRef<HTMLDivElement>(null);
   useEffect(() => rootRef.current?.focus(), []);
   ```

4. **ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚µãƒãƒ¼ãƒˆ**:
   - â†‘â†“ ã‚­ãƒ¼ã§é …ç›®é¸æŠ
   - Enter/Space ã§æ±ºå®š
   - Escape ã§ã‚¯ãƒ­ãƒ¼ã‚º

#### âš ï¸ Accessibility å•é¡Œ

**Location**: `src/react/ListBox/ListBox.tsx:32, 36`

```typescript
<li
    key={option.id}
    role="option"  // â† WAI-ARIA éæ¨å¥¨ï¼ˆæœ¬æ¥ã¯ <option> è¦ç´ ã‚’ä½¿ç”¨ï¼‰
    biome-ignore lint/a11y/no-interactive-element-to-noninteractive-role
    // â†‘ è­¦å‘Šã‚’ç„¡è¦–ã—ã¦ã„ã‚‹
>
```

**å•é¡Œ**:
- `<li role="option">` ã¯ WAI-ARIA ã§ã¯æ¨å¥¨ã•ã‚Œãªã„
- æ­£å¼ã«ã¯ `<option>` è¦ç´ ï¼ˆ`<select>` å†…ï¼‰ã‚’ä½¿ç”¨ã™ã¹ã
- ãŸã ã—ã€ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«è¨­è¨ˆã®éƒ½åˆä¸Šã€ä»•æ–¹ãªã„å®Ÿè£…

**è©•ä¾¡**: âš ï¸ è¨±å®¹å¯èƒ½ï¼ˆãŸã ã—ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã‚’æ¨å¥¨ï¼‰

---

### 3.2 PopUp ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/react/Popup/PopUp.tsx`
**è¡Œæ•°**: ~148è¡Œ

#### è¨­è¨ˆå“è³ª

**âœ… å¼·ã¿**:
1. **ResizeObserver ã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´**:
   ```typescript
   updateLayout(dimension: {
       top: number; left: number; windowWidth: number; windowHeight: number;
   }) {
       this.updateState((state) => ({
           ...state,
           height: Math.min(dimension.windowHeight - dimension.top - 8),
       }));
   }
   ```

2. **ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯ã¿å‡ºã—å¯¾å¿œ**:
   - ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¤–ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†è‡ªå‹•èª¿æ•´

3. **OverlayPortal ã¸ã®çµ±åˆ**:
   - React Portal ã§ç‹¬ç«‹ã—ãŸ DOM ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»
   - ã‚¹ã‚¿ã‚¤ãƒ«å¹²æ¸‰ã‚’å›é¿

#### âš ï¸ æ½œåœ¨çš„ãªå•é¡Œ

**z-index ã®ç®¡ç†**:
```typescript
// PopUp.tsx (äºˆæƒ³)
style={{ zIndex: 1000 }}  // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼Ÿ
```

**æ”¹å–„ææ¡ˆ**:
```typescript
// Styles.ts ã§ Z_INDEX ã‚’é›†ä¸­ç®¡ç†
export const Z_INDEX = {
    POPUP: 1000,
    DIALOG: 2000,
    MODAL: 3000,
} as const;
```

---

### 3.3 Select ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/react/Select/Select.tsx`
**è¡Œæ•°**: ~225è¡Œ

#### è¨­è¨ˆå“è³ª

**âœ… å¼·ã¿**:
1. **ListBox ã¨ PopUp ã®è¤‡åˆ**:
   - `<Select>` ãƒ©ãƒƒãƒ‘ãƒ¼ã§ä¸¡è€…ã‚’çµ„ã¿åˆã‚ã›
   - è‰¯ã„é–¢å¿ƒã®åˆ†é›¢

2. **TypeScript ã‚µãƒãƒ¼ãƒˆ**:
   ```typescript
   export interface SelectProps<T> {
       value?: T;
       onChange?: (value: T) => void;
       children?: SelectChildren<T>;
   }
   ```

#### ğŸ”´ CRITICAL BUG: typo ç™ºè¦‹

**Location**: `src/react/Select/Select.tsx:66`

```typescript
controller.on("clsoe.before", (state) => {
    // â†‘ "clsoe" ã¯ typo â†’ "close" ãŒæ­£ã—ã„
    setState(null);
});
```

**å½±éŸ¿**:
- `PopUp` ã® `"close.before"` ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒªãƒƒã‚¹ãƒ³ã•ã‚Œãªã„
- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œãªã„
- ãŸã ã—ã€`"close.after"` ã¯ã‚ã‚‹ãŸã‚ã€å®Ÿè³ªçš„ãªå•é¡Œã¯è»½å¾®

**ä¿®æ­£ææ¡ˆ**:
```typescript
controller.on("close.before", (state) => {
    setState(null);
});
```

**å„ªå…ˆåº¦**: ğŸ”´ HIGHï¼ˆå³åº§ã«ä¿®æ­£ã™ã¹ãï¼‰

---

### 3.4 InstrumentSelect ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ToolBar/InstrumentSelect.tsx`
**è¡Œæ•°**: ~65è¡Œ

#### è¨­è¨ˆå“è³ª

**âœ… å¼·ã¿**:
1. **Select ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½¿ç”¨**:
   - UI ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€

2. **ãƒ—ãƒªã‚»ãƒƒãƒˆåˆ—æŒ™**:
   ```typescript
   <Select.Option
       key={i}
       value={i}
       label={preset.name}
   />
   ```

#### âš ï¸ ã‚³ãƒ¼ãƒ‰é‡è¤‡

**å•é¡Œ**: `InstrumentSelectDialog.tsx` ã¨ã®ã‚³ãƒ¼ãƒ‰é‡è¤‡

**InstrumentSelect.tsx** (è¡Œ31-65):
```typescript
{isLoading ? (
    <Select.Disabled>Loading...</Select.Disabled>
) : (
    <>
        {presets.map((preset, i) => (
            <Select.Option
                key={i}
                value={i}
                label={preset.name}
                onChange={(presetIndex) => {
                    const instrumentKey = new SoundFontInstrumentKey(
                        soundFontUrl,
                        presetIndex,
                    );
                    selectInstrument(instrumentKey);
                }}
            />
        ))}
    </>
)}
```

**InstrumentSelectDialog.tsx** (è¡Œ125-151):
```typescript
{isLoading ? (
    <div>èª­ã¿è¾¼ã¿ä¸­...</div>
) : (
    <ListBox
        value={presetIndex}
        onChange={(presetIndex) => {
            const instrumentKey = new SoundFontInstrumentKey(
                soundFontUrl,
                presetIndex,
            );
            selectInstrument(instrumentKey);
        }}
    >
        {presets.map((preset, i) => (
            <ListBox.Option key={i} value={i}>
                {preset.name}
            </ListBox.Option>
        ))}
    </ListBox>
)}
```

**é‡è¤‡å†…å®¹**:
- ãƒ—ãƒªã‚»ãƒƒãƒˆåˆ—æŒ™ãƒ­ã‚¸ãƒƒã‚¯
- SoundFontInstrumentKey ç”Ÿæˆ
- selectInstrument() å‘¼ã³å‡ºã—

**æ¨å¥¨**: å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ–

---

### 3.5 é…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚­ãƒ¼ä½¿ç”¨

**Location**: `src/ToolBar/InstrumentSelect.tsx:58`

```typescript
{presets.map((preset, i) => (
    <Select.Option
        key={i}          // â† ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚­ãƒ¼ã«ä½¿ç”¨
        value={i}
        label={preset.name}
    />
))}
```

**å•é¡Œ**:
- React ã®éæ¨å¥¨è­¦å‘Š: "Do not use array index as key"
- ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãŒå¤‰å‹•ã™ã‚‹å ´åˆã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«ä¸å…·åˆã®å¯èƒ½æ€§

**å¯¾å¿œæ–¹æ³•**:
```typescript
// Option A: ä¸€æ„ãªIDã‚’ä½¿ç”¨
<Select.Option
    key={`${soundFontUrl}:${preset.bank}:${preset.number}`}
    value={i}
    label={preset.name}
/>

// Option B: hashã‚’ä½¿ç”¨
key={`preset-${hash(preset.name)}`}
```

**ç¾çŠ¶ã§ã¯éå•é¡Œ**: ãƒ—ãƒªã‚»ãƒƒãƒˆé…åˆ—ãŒé™çš„ã§ã‚ã‚Œã°ã€å®Ÿè³ªçš„ãªå•é¡Œã¯ãªã„ï¼ˆãŸã ã—ã€å°†æ¥çš„ãªãƒªã‚¹ã‚¯ï¼‰

---

## 4. æ–°è¦ã«ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ

### 4.1 ğŸ”´ CRITICAL: Select ã® typo bug

**Status**: æœªä¿®æ­£

**ä¿®æ­£ã‚³ã‚¹ãƒˆ**: 1 è¡Œ
**å½±éŸ¿**: Mediumï¼ˆclose.before ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ï¼‰

---

### 4.2 ğŸŸ¡ MEDIUM: ListBox â†” Select ã®é‡è¤‡å®Ÿè£…

**Location**:
- `src/react/ListBox/ListBoxController.tsx` (~45è¡Œ)
- `src/react/Select/Select.tsx` (éƒ¨åˆ†çš„ãªé‡è¤‡å®Ÿè£…)

**å•é¡Œ**:
```typescript
// ListBoxController: çŠ¶æ…‹ç®¡ç†
setSelectedOptionId(optionId: string | null) {
    this.updateState((state) => state.setSelectedOptionId(optionId));
    this.emit("change", this.state);
}

// Select: ç‹¬ç«‹ã—ãŸçŠ¶æ…‹ç®¡ç†
const [selectedValue, setSelectedValue] = useState(/* ... */);
```

**é‡è¤‡å†…å®¹**:
- é¸æŠé …ç›®ã®ç®¡ç†
- å¤‰æ›´é€šçŸ¥ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

**æ¨å¥¨**: Select ã‚’ ListBoxController ã«çµ±åˆ

```typescript
// æ”¹å–„æ¡ˆ
export const Select = forwardRef<ListBoxController, SelectProps>(
    (props, ref) => (
        <ListBox
            ref={ref}
            {...props}
        >
            <PopUp>
                {/* ... */}
            </PopUp>
        </ListBox>
    ),
);
```

---

### 4.3 ğŸŸ¡ MEDIUM: InstrumentSelect â†” InstrumentSelectDialog ã®é‡è¤‡

**Location**:
- `src/ToolBar/InstrumentSelect.tsx` (è¡Œ31-65)
- `src/InstrumentDialog/InstrumentSelectDialog.tsx` (è¡Œ125-151)

**é‡è¤‡ã‚³ãƒ¼ãƒ‰**:
1. ãƒ—ãƒªã‚»ãƒƒãƒˆåˆ—æŒ™ãƒ­ã‚¸ãƒƒã‚¯
2. SoundFontInstrumentKey ç”Ÿæˆ
3. selectInstrument() å‘¼ã³å‡ºã—
4. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®å‡¦ç†

**æ¨å¥¨**: å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ `InstrumentPresetSelector` ã‚’ä½œæˆ

```typescript
// æ–°è¦: InstrumentPresetSelector.tsx
export function InstrumentPresetSelector({
    soundFontUrl,
    presets,
    isLoading,
    onSelect,
}: {
    soundFontUrl: string;
    presets: Array<{ name: string }>;
    isLoading: boolean;
    onSelect: (instrumentKey: SoundFontInstrumentKey) => void;
}) {
    return (
        <>
            {isLoading ? (
                <div>èª­ã¿è¾¼ã¿ä¸­...</div>
            ) : (
                <>
                    {presets.map((preset, i) => (
                        <SelectOption
                            key={i}
                            value={i}
                            label={preset.name}
                            onClick={() => {
                                onSelect(new SoundFontInstrumentKey(soundFontUrl, i));
                            }}
                        />
                    ))}
                </>
            )}
        </>
    );
}

// InstrumentSelect.tsx ã§ä½¿ç”¨
<InstrumentPresetSelector
    soundFontUrl={soundFontUrl}
    presets={presets}
    isLoading={isLoading}
    onSelect={selectInstrument}
/>
```

---

### 4.4 ğŸŸ¡ MEDIUM: CanvasUIController ã®è¤‡é›‘æ€§

**Location**: `src/CanvasUIController/CanvasUIController.ts`

**å•é¡Œ**:
- ãƒã‚¤ãƒ³ã‚¿ãƒ¼æ“ä½œã€ãƒ‰ãƒ©ãƒƒã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™è¨ˆç®—ãªã©ãŒæ··åœ¨
- å˜ä¸€è²¬ä»»åŸå‰‡ã«é•å
- ãƒ†ã‚¹ãƒˆå›°é›£

**ä¾‹**:
```typescript
// CanvasUIController.ts
class CanvasUIController {
    handlePointerDown(ev: PointerEvent) {
        // 1. åº§æ¨™è¨ˆç®—
        const canvasPosition = this.getCanvasPosition(ev);

        // 2. ãƒãƒ³ãƒ‰ãƒ«æ¤œç´¢
        const handle = this.delegate.findHandle(canvasPosition);

        // 3. ãƒ‰ãƒ©ãƒƒã‚°ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        this.startDragSession(handle);

        // 4. ã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´
        this.updateCursor();
    }
}
```

**æ¨å¥¨**: ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ†é›¢

```typescript
// CanvasCoordinateCalculator.ts
class CanvasCoordinateCalculator {
    getCanvasPosition(ev: PointerEvent): CanvasUIPosition { ... }
}

// PointerInteractionHandler.ts
class PointerInteractionHandler {
    handlePointerDown(position: CanvasUIPosition): void { ... }
}

// CanvasUIController.ts (è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼)
class CanvasUIController {
    handlePointerDown(ev: PointerEvent) {
        const position = this.coordinateCalculator.getCanvasPosition(ev);
        this.interactionHandler.handlePointerDown(position);
    }
}
```

**å¯¾å¿œå„ªå…ˆåº¦**: ä¸­ï¼ˆç¾çŠ¶ã§ã‚‚å‹•ä½œã—ã¦ãŠã‚Šã€æ€¥ã‚’è¦ã•ãªã„ï¼‰

---

### 4.5 ğŸŸ¢ LOW: å‹å®‰å…¨æ€§ã®å•é¡Œ

#### 4.5.1 InstrumentKey ã®å‹ã‚­ãƒ£ã‚¹ãƒˆ

**Location**: `src/ToolBar/InstrumentSelect.tsx:21`

```typescript
const soundFontUrl = (instrumentKey as SoundFontInstrumentKey).url;
//  â†‘ å‹ã‚­ãƒ£ã‚¹ãƒˆï¼ˆå®‰å…¨ã§ã¯ãªã„ï¼‰
```

**å•é¡Œ**: InstrumentKey ã¯ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã§è¤‡æ•°ã®ç¨®é¡ãŒã‚ã‚‹

**æ¨å¥¨**: å‹ã‚¬ãƒ¼ãƒ‰

```typescript
function isSoundFontInstrumentKey(
    key: InstrumentKey,
): key is SoundFontInstrumentKey {
    return "url" in key && "presetIndex" in key;
}

// ä½¿ç”¨
if (isSoundFontInstrumentKey(instrumentKey)) {
    const soundFontUrl = instrumentKey.url;  // å‹å®‰å…¨
}
```

---

### 4.6 ğŸŸ¢ LOW: EventBus ãƒªã‚¹ãƒŠãƒ¼ã®å‰Šé™¤æ¼ã‚Œ

**Location**: `src/InstrumentStore.ts:41-57`

```typescript
constructor(bus: EventBus) {
    super(new InstrumentStoreState());
    bus
        .on("song.set.after", (song) => { ... })  // å‰Šé™¤ã•ã‚Œãªã„
        .on("channel.add.after", (channel) => { ... })
        .on("channel.update.after", (channelId, patch) => { ... })
}
```

**å•é¡Œ**: InstrumentStore ãŒå†ä½œæˆã•ã‚Œã‚‹å ´åˆï¼ˆé€šå¸¸ã¯ãªã„ï¼‰ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯

**æ¨å¥¨**: dispose() ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

```typescript
constructor(bus: EventBus) {
    super(new InstrumentStoreState());
    this.unsubscribers = [
        bus.on("song.set.after", ...),
        bus.on("channel.add.after", ...),
    ];
}

dispose() {
    this.unsubscribers.forEach(unsub => unsub?.());
}
```

**ç¾çŠ¶ã§ã®å½±éŸ¿**: ä½ï¼ˆé€šå¸¸ã€Store ã¯ singletonï¼‰

---

### 4.7 ğŸŸ¢ LOW: ãƒ¡ã‚½ãƒƒãƒ‰åã®å‘½åè¦ç´„

**å•é¡Œ**: ãƒ¡ã‚½ãƒƒãƒ‰åã®å‹•è©ã®ä½ç½®ãŒéå¯¾ç§°

| ã‚¯ãƒ©ã‚¹ | ãƒ¡ã‚½ãƒƒãƒ‰ |
|--------|---------|
| Editor | `setActiveChannel()`, `unselectAllNotes()` |
| SongStore | `setSong()`, `setNotes()` |
| InstrumentStore | `getOrLoad()` (ã‚»ãƒƒã‚¿ãƒ¼ãªã—) |
| InstrumentSelectDialog | `selectInstrument()` |

**æ¨å¥¨**: è¦ç´„ã‚’çµ±ä¸€

```typescript
// Option A: set/get/unselectã§çµ±ä¸€
editor.setActiveChannel()
editor.unselectAllNotes()
instrumentStore.setInstrument()

// Option B: å‹•è©ã‚’å…ˆé ­ã«çµ±ä¸€
editor.setActiveChannel()
editor.unselectAllNotes()
instrumentStore.getOrLoadInstrument()
dialog.selectInstrument()  // select ã¯ findã‹getã«çµ±ä¸€ï¼Ÿ
```

**ç¾çŠ¶ã§ã®å½±éŸ¿**: ä½ï¼ˆæ—¢ã«ç†è§£å¯èƒ½ï¼‰

---

## 5. æ”¹å–„å„ªå…ˆåº¦

### ğŸ”´ CRITICAL (å³åº§ã«å¯¾å¿œ)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | ãƒ•ã‚¡ã‚¤ãƒ« |
|----|------|------|--------|---------|
| 1 | Select.tsx ã® typo ä¿®æ­£ | ãƒã‚°ä¿®æ­£ | 1m | `src/react/Select/Select.tsx:66` |

---

### ğŸŸ¡ HIGH (æ¬¡ã‚¹ãƒ—ãƒªãƒ³ãƒˆ)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | ãƒ•ã‚¡ã‚¤ãƒ« |
|----|------|------|--------|---------|
| 2 | InstrumentSelect é‡è¤‡ã‚³ãƒ¼ãƒ‰çµ±åˆ | DRY åŸå‰‡ | 1-2h | `src/ToolBar/` + `src/InstrumentDialog/` |
| 3 | Select ã‚’ ListBox ã«çµ±åˆ | ã‚³ãƒ¼ãƒ‰é‡è¤‡å‰Šæ¸› | 1-2h | `src/react/Select/` + `src/react/ListBox/` |
| 4 | å‹ã‚¬ãƒ¼ãƒ‰è¿½åŠ  (InstrumentKey) | å‹å®‰å…¨æ€§ | 30m | `src/ToolBar/InstrumentSelect.tsx` |

---

### ğŸŸ¢ MEDIUM (å°†æ¥çš„)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | ãƒ•ã‚¡ã‚¤ãƒ« |
|----|------|------|--------|---------|
| 5 | CanvasUIController åˆ†é›¢ | å˜ä¸€è²¬ä»»åŸå‰‡ | 3-4h | `src/CanvasUIController/` |
| 6 | ãƒ¡ã‚½ãƒƒãƒ‰åã®è¦ç´„çµ±ä¸€ | å‘½åä¸€è²«æ€§ | 1h | å…¨ä½“ |
| 7 | EventBus ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤ç®¡ç† | ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ | 1-2h | stores å…¨ä½“ |

---

## 6. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡

### 6.1 å±¤æ§‹é€ ã®é€²åŒ–

#### å‰å›è©•ä¾¡ (3678d85)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        React Layer (Presentation)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Application Layer (Editors)           â”‚
â”‚   PianoRoll, ParameterEditor            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Use Case Layer (12 usecases)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Infrastructure Layer                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Domain Layer (Models)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¾åœ¨ã®è©•ä¾¡ (e14c2a7)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        React Presentation Layer (Component)         â”‚
â”‚  AppView, ToolBar, ChannelListView, StatusBar       â”‚
â”‚  æ–°: ListBox, PopUp, Select, InstrumentSelect       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Application Layer (Business Logic)                â”‚
â”‚   Editor, PianoRoll, ParameterEditor                â”‚
â”‚   CanvasUIController, KeyboardHandler               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Use Case Layer (12 Phased-Event-based UseCases)   â”‚
â”‚   âœ… emitPhasedEvents ã§çµ±ä¸€                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Infrastructure Layer (Event-driven)               â”‚
â”‚   EventBus (PhasedEvents), EditHistory, Stores     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Domain Layer (Immutable Models)                   â”‚
â”‚   Song, Channel, Note, Instrument                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è©•ä¾¡ã®å‘ä¸Š

| é …ç›® | å‰å› | ç¾åœ¨ | æ”¹å–„ |
|------|------|------|------|
| Phased Events å®Ÿè£… | 0% | 100% | +100% |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ•´ç†åº¦ | 7/10 | 8.5/10 | +21% |
| UI ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯çµ±ä¸€åº¦ | 6/10 | 8/10 | +33% |
| **ç·åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¹ã‚³ã‚¢** | **8.6/10** | **9/10** | **+5%** |

---

### 6.2 è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©•ä¾¡

#### EventBus ã® Phased Events ãƒ‘ã‚¿ãƒ¼ãƒ³

**å°å…¥åº¦**: 100% (ã™ã¹ã¦ã®å¤‰æ›´æ“ä½œã§ä½¿ç”¨)

**å‹ã‚·ã‚¹ãƒ†ãƒ ã®è³ª**: å„ªç§€
```typescript
type PhasedEvents<E> = {
    [K in keyof E as K extends string
        ? `${K}.before` | K | `${K}.after`
        : never]: E[K];
};
```

**ã‚¤ãƒ™ãƒ³ãƒˆä½¿ç”¨ç®‡æ‰€** (ç¢ºèªæ¸ˆã¿):
- PianoRoll ã® channel/notes å‰Šé™¤å‰å‡¦ç†
- Editor ã®è‡ªå‹•é¸æŠã‚¯ãƒªã‚¢
- SongStore ã®ãƒ¢ãƒ‡ãƒ«åŒæœŸ
- InstrumentStore ã®æ¥½å™¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†

---

#### DI ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æœ‰åŠ¹æ€§

**è©•ä¾¡**: âœ… ç¶™ç¶šã—ã¦åŠ¹æœçš„

**æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®æ´»ç”¨**:
- `ListBoxController` ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§çŠ¶æ…‹ã‚’å—ã‘å–ã‚‰ãªã„ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ç®¡ç†ï¼‰
- `PopUp` ã‚‚ç‹¬ç«‹ã—ãŸ Stateful æ‹¡å¼µ

**æ”¹å–„ä½™åœ°**: select/listbox ã¸ã®ä¾å­˜æ€§æ³¨å…¥ã®ç°¡ç´ åŒ–

---

## 7. ç·åˆè©•ä¾¡

### ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚³ã‚¢ã®å¤‰é·

| æŒ‡æ¨™ | å‰å› (3678d85) | ç¾åœ¨ (e14c2a7) | æ”¹å–„åº¦ |
|------|------------|------------|--------|
| ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | 9/10 | 9/10 | Â±0% |
| Phased Events | 0/10 | 10/10 | **+100%** âœ…âœ… |
| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå“è³ª | 7/10 | 8/10 | **+14%** âœ… |
| é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šæ¸› | 8.5/10 | 7.5/10 | **-12%** âš ï¸ |
| å‹å®‰å…¨æ€§ | 8/10 | 7.5/10 | **-6%** âš ï¸ |
| ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ | 9/10 | 9/10 | Â±0% |
| **ç·åˆã‚¹ã‚³ã‚¢** | **8.6/10** | **8.8/10** | **+2%** âœ… |

### å¼·ã¿ âœ…

1. **Phased Events ã®å®Œå…¨å®Ÿè£…**: EventBus ã®è¨­è¨ˆãŒå¤§å¹…ã«æ”¹å–„
2. **æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å“è³ª**: ListBox, PopUp, Select ã®è¨­è¨ˆã¯å …å®Ÿ
3. **ä¸å¤‰æ€§ã®ä¸€è²«æ€§**: æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚ Stateful ãƒ‘ã‚¿ãƒ¼ãƒ³æ¡ç”¨
4. **ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å‡¦ç†ã®é›†ç´„**: ActionRegistry å‰Šé™¤ã«ã‚ˆã‚Šç›´æ„Ÿçš„ã«
5. **DI ã«ã‚ˆã‚‹ä¾å­˜æ€§ç®¡ç†**: å¼•ãç¶šãåŠ¹æœçš„

### èª²é¡Œ âš ï¸

1. **Select ã® typo bug**: å³åº§ã«ä¿®æ­£ãŒå¿…è¦
2. **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé‡è¤‡**: ListBox/Select, InstrumentSelect/Dialog ã®é‡è¤‡
3. **å‹å®‰å…¨æ€§ã®ä½ä¸‹**: as ã‚­ãƒ£ã‚¹ãƒˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚­ãƒ¼ä½¿ç”¨
4. **CanvasUIController ã®è¤‡é›‘æ€§**: ãƒ†ã‚¹ãƒˆå›°é›£ã§ä¿å®ˆæ€§ãŒä½ã„
5. **Accessibility ç„¡è¦–**: ListBox ã® WAI-ARIA éæ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

### å…¨ä½“çš„ãªæ–¹å‘æ€§

âœ… **æ­£æ–¹å‘ã§ã®æ”¹å–„**:
- Phased Events ã«ã‚ˆã‚‹å …å®Ÿãªè¨­è¨ˆ
- æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® Stateful çµ±ä¸€
- ActionRegistry å‰Šé™¤ã«ã‚ˆã‚‹ç°¡ç´ åŒ–

âš ï¸ **æ”¹å–„ãŒå¿…è¦ãªé ˜åŸŸ**:
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé‡è¤‡ã®çµ±åˆ
- å‹å®‰å…¨æ€§ã®å¼·åŒ–
- Accessibility ã¸ã®å¯¾å¿œ

---

## 8. å®Ÿè£…ææ¡ˆ

### Phase 1: å³åº§ (1æ™‚é–“)

**1. Select.tsx ã® typo ä¿®æ­£**

```typescript
// src/react/Select/Select.tsx:66
- controller.on("clsoe.before", (state) => {
+ controller.on("close.before", (state) => {
    setState(null);
});
```

**æ¤œè¨¼**: Select ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’é–‹é–‰ã—ã¦ã€close.before ãŒæ­£å¸¸ã«ç™ºç«ã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

### Phase 2: çŸ­æœŸ (2-3æ™‚é–“)

**2. InstrumentSelect é‡è¤‡ã‚³ãƒ¼ãƒ‰çµ±åˆ**

æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ `InstrumentPresetSelector` ã‚’ä½œæˆ:

```typescript
// src/InstrumentDialog/InstrumentPresetSelector.tsx
export function InstrumentPresetSelector({
    soundFontUrl,
    presets,
    isLoading,
    onSelect,
}: {
    soundFontUrl: string;
    presets: Preset[];
    isLoading: boolean;
    onSelect: (instrumentKey: SoundFontInstrumentKey) => void;
}) {
    if (isLoading) return <div>èª­ã¿è¾¼ã¿ä¸­...</div>;

    return (
        <>
            {presets.map((preset, i) => (
                <SelectOption
                    key={`${soundFontUrl}:${i}`}
                    value={i}
                    label={preset.name}
                    onSelect={(presetIndex) => {
                        onSelect(new SoundFontInstrumentKey(soundFontUrl, presetIndex));
                    }}
                />
            ))}
        </>
    );
}
```

**çµ±åˆãƒã‚¤ãƒ³ãƒˆ**:
- `InstrumentSelect.tsx` ã§ `InstrumentPresetSelector` ã‚’ä½¿ç”¨
- `InstrumentSelectDialog.tsx` ã§ã‚‚åŒæ§˜ã«ä½¿ç”¨

---

**3. å‹ã‚¬ãƒ¼ãƒ‰è¿½åŠ  (InstrumentKey)**

```typescript
// src/ToolBar/InstrumentSelect.tsx
function isSoundFontInstrumentKey(
    key: InstrumentKey,
): key is SoundFontInstrumentKey {
    return "url" in key && "presetIndex" in key;
}

// ä½¿ç”¨
if (isSoundFontInstrumentKey(instrumentKey)) {
    const soundFontUrl = instrumentKey.url;
    // ...
}
```

---

### Phase 3: ä¸­æœŸ (2-3æ—¥)

**4. Select ã‚’ ListBox ã«çµ±åˆ**

```typescript
// src/react/Select/Select.tsx ã‚’ ListBox ã«çµ±åˆ
export const Select = React.forwardRef<ListBoxController, SelectProps>(
    ({ children, ...props }, ref) => {
        const listBoxRef = useRef<ListBoxController>(null);
        useImperativeHandle(ref, () => listBoxRef.current!);

        return (
            <PopUp>
                <ListBox ref={listBoxRef} {...props}>
                    {children}
                </ListBox>
            </PopUp>
        );
    },
);
```

---

**5. Accessibility å¯¾å¿œ**

```typescript
// src/react/ListBox/ListBox.tsx
<li
    key={option.id}
    role="listbox"  // â† "option" ã§ã¯ãªã "listbox" ã«å¤‰æ›´
    aria-selected={selectedId === option.id}
    tabIndex={selectedId === option.id ? 0 : -1}
>
```

---

### Phase 4: é•·æœŸ (1é€±é–“)

**6. CanvasUIController ã®åˆ†é›¢**

```typescript
// src/CanvasUIController/CanvasCoordinateCalculator.ts
export class CanvasCoordinateCalculator {
    getCanvasPosition(ev: PointerEvent, container: HTMLElement): CanvasUIPosition {
        // åº§æ¨™è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
    }
}

// src/CanvasUIController/PointerInteractionHandler.ts
export class PointerInteractionHandler implements CanvasUIControllerDelegate {
    handlePointerDown(position: CanvasUIPosition): void {
        // ãƒã‚¤ãƒ³ã‚¿ãƒ¼å‡¦ç†
    }
}

// src/CanvasUIController/CanvasUIController.ts (è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼)
export class CanvasUIController {
    private coordinateCalculator = new CanvasCoordinateCalculator();
    private interactionHandler = new PointerInteractionHandler(this.delegate);

    handlePointerDown(ev: PointerEvent): void {
        const position = this.coordinateCalculator.getCanvasPosition(ev, this.container);
        this.interactionHandler.handlePointerDown(position);
    }
}
```

---

## 9. æœ€æ–°ã®å¤‰æ›´ãŒå‰å›æŒ‡æ‘˜ã«å¯¾ã™ã‚‹å¯¾å¿œçŠ¶æ³

| å‰å›æŒ‡æ‘˜ | ç¾åœ¨ã®çŠ¶æ…‹ | å¯¾å¿œåº¦ |
|--------|----------|--------|
| emitWithPhases ãƒ˜ãƒ«ãƒ‘ãƒ¼ | âœ… å®Ÿè£…å®Œäº† | 100% |
| EventEmitter unsubscribe | âš ï¸ éƒ¨åˆ†å®Ÿè£… (ListBox ã¯å®Ÿè£…ã€Store ã¯æœªå®Ÿè£…) | 50% |
| ActionRegistry çµ±åˆ | âœ… å‰Šé™¤ | 100% |
| ParameterEditor EventBus | âŒ æœªå®Ÿè£… | 0% (ä¸è¦ã¨åˆ¤æ–­) |
| ã‚³ãƒ¼ãƒ‰é‡è¤‡ | âš ï¸ æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§é‡è¤‡ç™ºç”Ÿ | -20% |
| å‹å®‰å…¨æ€§ | âš ï¸ ä½ä¸‹ (as ã‚­ãƒ£ã‚¹ãƒˆã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚­ãƒ¼) | -10% |

---

## 10. çµè«–

### å‰å›ã‹ã‚‰ã®é€²å±•

âœ… **Phased Events ã®å®Œå…¨å®Ÿè£…ã«ã‚ˆã‚Šã€EventBus ã®ãƒ‘ã‚¿ãƒ¼ãƒ³çµ±ä¸€ãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸã€‚** ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤ã§ã® ã‚³ãƒ¼ãƒ‰é‡è¤‡ãŒå®Œå…¨ã«æ’é™¤ã•ã‚Œã¾ã—ãŸã€‚

âœ… **æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (ListBox, PopUp, Select) ã¯å …å®Ÿãªè¨­è¨ˆã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€Stateful ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¸€è²«ã—ã¦æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚**

**ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹**:
- **8.6/10** (å‰å›) â†’ **8.8/10** (ç¾åœ¨) : **+2% ã®å‘ä¸Š**
- Phased Events: 0% â†’ 100%ï¼ˆå¤§å¹…æ”¹å–„ï¼‰
- ãŸã ã—ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé‡è¤‡ã«ã‚ˆã‚‹æ‡¸å¿µï¼ˆ-2%ï¼‰

### ç¾åœ¨ã®è©•ä¾¡

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: â­â­â­â­â­ (Excellent)
- å±¤æ§‹é€ ãŒæ˜ç¢º
- Phased Events ã«ã‚ˆã‚‹ event-driven è¨­è¨ˆ
- DI ã«ã‚ˆã‚‹ä¾å­˜æ€§ç®¡ç†ãŒå …å®Ÿ

**ã‚³ãƒ¼ãƒ‰å“è³ª**: â­â­â­â­ (Good to Excellent)
- æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸å¤‰æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³æ¡ç”¨
- ãŸã ã—ã€typo bug (Select) ãŒå­˜åœ¨
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé‡è¤‡ãŒæ‡¸å¿µææ–™

**ä¿å®ˆæ€§**: â­â­â­â­ (Good)
- å˜ä¸€è²¬ä»»åŸå‰‡ãŒã»ã¼é”æˆ
- ãŸã ã—ã€CanvasUIController ã®è¤‡é›‘æ€§ãŒãƒãƒƒã‚¯

### æœ€çµ‚è©•ä¾¡

**Phased Events ã®å®Ÿè£…ã«ã‚ˆã‚Šã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å …å®Ÿæ€§ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚** æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚è¨­è¨ˆå“è³ªãŒé«˜ãã€å…¨ä½“çš„ã«ã¯å‰é€²ã—ã¦ã„ã¾ã™ã€‚

**ãŸã ã—ã€ä»¥ä¸‹ã®ç‚¹ã¸ã®å¯¾å¿œãŒæ¨å¥¨ã•ã‚Œã¾ã™**:
1. ğŸ”´ **typo ä¿®æ­£** (Select.tsx:66) - å³åº§ã«å¯¾å¿œ
2. ğŸŸ¡ **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé‡è¤‡çµ±åˆ** - æ¬¡ã‚¹ãƒ—ãƒªãƒ³ãƒˆ
3. ğŸŸ¡ **å‹å®‰å…¨æ€§ã®å¼·åŒ–** - å‹ã‚¬ãƒ¼ãƒ‰è¿½åŠ 

**æ¨å¥¨**:
- Phase 1 (typo ä¿®æ­£) ã¯æœ¬æ—¥ä¸­ã«å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨
- Phase 2-3 (é‡è¤‡ã‚³ãƒ¼ãƒ‰çµ±åˆ) ã¯æ¬¡ã‚¹ãƒ—ãƒªãƒ³ãƒˆ
- Phase 4 (CanvasUIController åˆ†é›¢) ã¯å„ªå…ˆåº¦ã‚’æ¤œè¨

---

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ—¥**: 2025-12-12
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½è€…**: Claude Code
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 80+ TypeScript ãƒ•ã‚¡ã‚¤ãƒ«
**ç·ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: ~11,000 è¡Œ (æ¨å®š)
**æ¯”è¼ƒå¯¾è±¡**: REVIEW_RESULT_20251208_041445.md (å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼)

---

Contextãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€JSX(ã¨ã„ã†ã‚ˆã‚ŠXML)ã®Composableãªæ€§è³ªã‚’ãã®ã¾ã¾å†åˆ©ç”¨ã—ã¦ãŠã‚Šã€
åˆ©ç”¨è€…å´ã®ç›®ç·šã§ã¯ComposeãŒä¸€ç•ªç›´æ„Ÿçš„ã«è¡Œãˆã‚‹ã¨ã„ã†åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿéš›ã«Composeã‚’è¡Œã„æœ€çµ‚çš„ãªDOMã‚’æ§‹ç¯‰ã™ã‚‹æ®µéšã«ä½™è¨ˆãªã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ã€Œé–‹ç™ºè€…ç›®ç·šã§ã®åˆ©ä¾¿æ€§ã®ãŸã‚ã«ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã«ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã€ã¨ã„ã†æ°—æŒã¡æ‚ªã•ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ä¹±ç”¨ã™ã‚‹ã¨JSXæ§‹é€ ã¨å®Ÿéš›ã®DOMæ§‹é€ ãŒä¹–é›¢ã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨ã„ã†æ‡¸å¿µã‚‚ã‚ã‚Šã¾ã™ã€‚

æœ¬è³ªçš„ã«ã‚„ã‚ŠãŸã„ã“ã¨ã¯React.Childrenã‚’ã¤ã‹ã£ãŸå­è¦ç´ ã®å‹ã«ã‚ˆã‚‹åˆ†å²ãªã®ã§ã™ãŒReact.Childrenã®ã‚ˆã†ãªæ‰‹ç¶šãå‹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯é¿ã‘ã‚‹ã¹ãã¨ã„ã†å…¬å¼ã‹ã‚‰ã®æŒ‡é‡ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã‚’è¸ã¾ãˆã€ã‚‚ã†å°‘ã—æŸ”è»Ÿæ€§ã‚’æ¸›ã‚‰ã—ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã®å°‘ãªã„APIè¨­è¨ˆã¯ãªã„ã§ã—ã‚‡ã†ã‹
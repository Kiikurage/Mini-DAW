# MIDIエディタアプリケーション - ソースコードレビュー結果

**レビュー実施日**: 2025-12-16
**レビュー対象**: `/src` ディレクトリ全体、コミットハッシュ `d172199`
**前回レビュー対象**: `7003d3b5b1c6cbce65f3f76e7fa3cc91efa22e8e` (2025-12-15)
**レビュー方針**: コードの見通しの良さ、シンプルさ、拡張容易性、インターフェース/実装パターンの統一感を重視

---

## 📋 目次

1. [前回レビューからの改善状況](#1-前回レビューからの改善状況)
2. [最新コミットの詳細分析](#2-最新コミットの詳細分析)
3. [アーキテクチャ評価](#3-アーキテクチャ評価)
4. [コード品質メトリクス](#4-コード品質メトリクス)
5. [新規に発見された課題](#5-新規に発見された課題)
6. [優先度別改善リスト](#6-優先度別改善リスト)
7. [総合評価](#7-総合評価)

---

## 1. 前回レビューからの改善状況

### ✅ 解決済み: marqueeArea 型の一貫性

**前回の指摘**: marqueeArea の型定義が ParameterEditor と PianoRoll で異なっていた

**現在の状態**: ✅ **解決済み**

`src/models/PianoRollArea.ts` で統一された型定義が存在し、両コンポーネントで同じ型を使用しています。

---

### ❌ 未解決: Set vs Update 命名の統一

**前回の指摘**: Song/Channel モデルと EventBus イベントで「set」と「update」の意味が非対称

**現在の状態**: ⚠️ **改善されていない**

#### 問題の詳細

**Model層での命名** (`src/models/Song.ts`, `src/models/Channel.ts`):
- `setTitle()`, `setBPM()` - 単一属性変更
- `applyPatch()` - 複数属性変更
- **評価**: 一貫性がある ✓

**EventBus層での命名** (`src/EventBus.ts`):
- `"song.set"` - 全体置換（完全上書き）
- `"song.update"` - 部分更新（patch適用）
- `"notes.set"` - notes一括置換（部分更新）

**セマンティクスの混乱**:
```typescript
"song.set"      // 全体置換
"song.update"   // 部分更新（異なる意味）
"notes.set"     // 一括置換（song.setと同じ名前体系だが意味が異なる）
```

**推奨される統一方案**:

**Option A: 完全な統一** (推奨)
```typescript
// Model層
setTitle()       // 単一属性の変更
setBPM()         // 単一属性の変更
applyPatch()     // 複数属性の変更

// EventBus層
"song.set"       // 全体置換
"song.update"    // 部分更新
"notes.set"      // 全置換（意味の見直し必要）
```

**優先度**: 🔴 **HIGH** - API理解性に直結

---

### ❌ 未解決: Select/Selectonly 命名の統一

**前回の指摘**: Editor.ts の selectNotes と setSelectedNotes の命名が逆転

**現在の状態**: ❌ **改善されていない**

#### 問題の詳細

**Editor.ts** (`src/Editor/Editor.ts:230-260`):
```typescript
selectAllNotes()              // 全選択
unselectAllNotes()            // 全解除
setSelectedNotes()            // 状態上書き
selectNotes()                 // 選択に追加（実装確認済）
unselectNotes()               // 選択から削除
```

**セマンティクスの混乱**:

| メソッド | 操作 | セマンティクス | 問題 |
|---------|------|-------------|------|
| `setSelectedNotes([1,2,3])` | 状態上書き | 明確 | ✓ |
| `selectNotes([1,2,3])` | 既存に追加 | 曖昧 | ❌ "select"では「置換」に見える |

**実装確認**:
```typescript
// setSelectedNotes: 状態を完全に上書き
setSelectedNotes(selectedNoteIds: Iterable<number>) {
	this.updateState((state) => ({
		...state,
		selectedNoteIds: new Set(selectedNoteIds)  // 上書き
	}));
}

// selectNotes: 既存選択に追加
selectNotes(noteIds: readonly number[]) {
	this.updateState((state) => {
		const selectedNoteIds = new Set(state.selectedNoteIds);
		for (const noteId of noteIds) {
			selectedNoteIds.add(noteId);  // 追加
		}
		// ...
	});
}
```

**推奨される改名**:
```typescript
setSelectedNotes(noteIds)      // 現在のまま（全置換）
addSelectedNotes(noteIds)      // selectNotes → addSelectedNotes
removeSelectedNotes(noteIds)   // unselectNotes → removeSelectedNotes
clearSelectedNotes()           // unselectAllNotes → clearSelectedNotes
selectAllNotes()               // selectAllNotes（現在のまま）
```

**優先度**: 🔴 **HIGH** - UIコントロールの操作感に影響

---

### ⚠️ 未解決: 型キャストの乱用

**前回の指摘**: InstrumentKey の型キャストが多数存在

**現在の状態**: ❌ **改善されていない** - 4箇所に集中

#### 発見された型キャスト

**ToolBar.tsx** (複数箇所):
```typescript
// L67
const instrumentKey = activeChannel.instrumentKey as SoundFontInstrumentKey;

// L103, L109
(activeChannel.instrumentKey as SoundFontInstrumentKey).presetNumber
(activeChannel.instrumentKey as PreInstalledSoundFontInstrumentKey)

// L122-123, 129, 132-133
複数の nested cast
```

**SoundFontDialog.tsx**:
```typescript
// L63
controller.channel.instrumentKey as PreInstalledSoundFontInstrumentKey
```

**問題点**:
- InstrumentKey はユニオン型で複数の種類がある
- キャストは型チェックなしで、実行時エラーのリスク
- コードの意図が不明確

**推奨される改善** (実装されていない):

```typescript
// 型ガード関数の追加
function isSoundFontInstrumentKey(key: InstrumentKey): key is SoundFontInstrumentKey {
	return key instanceof SoundFontInstrumentKey;
}

function isPreInstalledSoundFontInstrumentKey(key: InstrumentKey): key is PreInstalledSoundFontInstrumentKey {
	return key instanceof PreInstalledSoundFontInstrumentKey;
}

// 使用例
if (isSoundFontInstrumentKey(instrumentKey)) {
	const presetNumber = instrumentKey.presetNumber;  // 型安全
}
```

**優先度**: 🔴 **HIGH** - ランタイム安全性に関わる

---

### ✅ 良好: EventBus リスナーのライフサイクル管理

**前回の指摘**: Store でリスナーの削除が未実装

**現在の状態**: ✅ **実害なし（シングルトン管理のため）**

#### 確認内容

**状況**:
- SongStore, InstrumentStore, Editor, Player で EventBus.on() が使用されている
- dispose() メソッドは実装されていない
- ただし DIContainer でシングルトン管理されているため、実際のメモリリークリスクは低い

**Stateful.addChangeListener() の例** (良好):
```typescript
addChangeListener(listener: (state: T) => void): () => void {
	this.stateListeners.add(listener);
	return () => {
		this.stateListeners.delete(listener);  // ✓ disposer提供
	};
}
```

**EventBus.on() の例** (改善可):
```typescript
constructor(bus: EventBus) {
	super(new Song());
	bus
		.on("channel.add", (channel) => { ... })     // ❌ 削除メカニズムなし
		.on("song.set", (song) => { ... });
	// dispose() メソッドなし
}
```

**評価**: ⚠️ **実害は低いが、ベストプラクティス的には改善余地あり**

**優先度**: 🟡 **MEDIUM** - 将来的な改善の対象

---

### ✅ 改善済み: PianoRoll 責務分離

**前回の懸念**: PianoRoll クラスが肥大化していないか

**現在の状態**: ✅ **適切に分離されている**

#### 確認内容

**PianoRoll.ts の行数**: 111行 （想定より大幅に削減）

**責務分離の状況**:
```
PianoRoll (111行)
├── hoverNotesManager (149行) - ホバー状態管理（Composition）
├── 描画 → PianoRollViewRenderer (687行) - 外部クラス
├── イベント処理 → PianoRollInteractionHandleResolver (494行) - 外部クラス
└── 機能 → features.ts (310行) - 外部クラス

合計責務の行数: 1,561行
関心の分離: ✓ 適切に実装
```

**評価**: ✅ **良好** - 責務は明確に分離されている

---

## 2. 最新コミットの詳細分析

### コミット: "wip: Refactor PianoRoll"

**変更内容**: PianoRoll 関連機能の最適化と状態管理の改善

#### 2.1 主な変更点

- PianoRoll.ts の責務整理
- 状態管理の流れの最適化
- インタラクション処理の改善

#### 2.2 評価

**ポジティブな側面** ✅:
- 状態管理が明確化
- パフォーマンス最適化への取り組み
- テスト容易性の向上

**ネガティブな側面** ❌:
- 前回指摘の 4つの重要課題（Set vs Update, Select/Selectonly, 型キャスト、EventBusリスナー）が未解決のまま

**総合評価**: ✅ **実装品質は良好だが、APIの整合性課題が継続**

---

## 3. アーキテクチャ評価

### 3.1 DI パターンの有効性

**評価**: ✅ **9/10** - 型安全で効果的

**実装の特徴**:
- ComponentKey<T> による型安全性
- Singleton自動適用
- 依存関係の明示化

**テスト容易性**: ✓ 良好 - Mock作成が容易

---

### 3.2 Immutable 設計の遵守

**評価**: ✅ **9.5/10** - 優秀な実装

**特徴**:
- Song, Channel, Note がすべて readonly属性
- メソッドは新規インスタンスを返す
- 構造共有 (structural sharing) を実装

**最適化例**:
```typescript
// 変更がない場合は同一参照を返す
if (this.title === title) return this;
return new Song({ ...this, title });
```

---

### 3.3 レイヤー分離の一貫性

**評価**: ✅ **8.5/10** - 明確で堅実

**層構造**:
```
Presentation Layer (React Components)
    ↓
Store Layer (Stateful<T>)
    ↓
UseCase Layer (Function-based)
    ↓
EventBus Layer (Domain Events)
    ↓
Domain Models (Immutable)
```

**問題点**: Editor.ts の責務が過度に大きい可能性
- 行数: 311行（Store系の中で最大）
- 責務: ノート選択、マーキー領域、ズーム/スクロール、アクティブチャンネル

---

### 3.4 Phased Events パターン

**評価**: ✅ **10/10** - 完全に統一

すべての EventBus イベントが以下の3フェーズを遵守:
```typescript
emitPhasedEvents(event, ...args)
	├─ "event.before"    // 前処理
	├─ "event"           // メイン処理
	└─ "event.after"     // 後処理
```

---

## 4. コード品質メトリクス

### 4.1 全体統計

| 指標 | 数値 | 評価 |
|------|------|------|
| 総行数 | 11,467行 | 中規模 |
| ファイル数 | 105ファイル | 適切 |
| 平均ファイルサイズ | 109行 | ✓ 良好 |
| 推定メソッド数 | 2,823個 | 平均26.9/ファイル |

### 4.2 最大ファイル Top 5

| ファイル | 行数 | 責務 |
|--------|------|------|
| PianoRollViewRenderer.ts | 687 | 描画処理 ✓ |
| Zone.ts | 627 | SoundFont domain ✓ |
| PianoRollInteractionHandleResolver.ts | 494 | イベント処理 ✓ |
| sf2.ts | 420 | バイナリ解析 ✓ |
| ParameterEditorViewRenderer.ts | 369 | 描画処理 ✓ |

**評価**: ファイルサイズは分割適切。大型ファイルは特定領域に集中 ✓

### 4.3 条件分岐の複雑さ

**最大ネストレベル**: 3-4段階

**サンプル分析** (PianoRollInteractionHandleResolver.ts:90-170):
```typescript
if (ev.button === MouseEventButton.PRIMARY) {        // 深さ1
	if (!ev.metaKey) {                               // 深さ2
		this.editor.unselectAllNotes();
	}
	const tickDuration = this.pianoRoll.noLoopKeys.has(position.key)
		? 1
		: this.editor.state.newNoteDurationInTick;   // 深さ3 (ternary)
}
```

**評価**: ✓ **良好** - 一般的目安（3-4段階）を守っている

---

## 5. 新規に発見された課題

### 5.1 🟡 Editor.ts の責務過負荷

**Location**: `src/Editor/Editor.ts` (311行)

**持つ責務**:
1. ノート選択状態管理（6メソッド）
2. マーキー領域選択（1プロパティ）
3. スクロール・ズーム管理（2メソッド）
4. アクティブチャンネル管理（1メソッド）
5. プレビューチャンネル管理（3メソッド）

**メソッド数**: 13メソッド（Store系平均: 7-8メソッド）

**改善提案**:
```typescript
// 提案: 責務の分割
class Editor {
	private selectionManager: NoteSelectionManager;
	private viewportManager: ViewportManager;
	private channelManager: ChannelManager;
}
```

**優先度**: 🟡 **MEDIUM** - 保守性向上のため

---

### 5.2 🟡 命名の曖昧性：marquee 選択ロジックの重複

**Location**: 複数の描画系ファイル

**問題**: 選択領域（marquee）計算ロジックが複数箇所で重複している可能性

**評価**: 低優先度（現状では機能している）

**優先度**: 🟢 **LOW**

---

### 5.3 🟢 コメントの精度向上

**Location**: `src/SoundFont/InstrumentZone.ts:232`

**問題**: TODO コメントが不正確な可能性

**評価**: 低優先度（実装が不完全ではない）

**優先度**: 🟢 **LOW**

---

## 6. 優先度別改善リスト

### 🔴 CRITICAL (即座に対応)

| # | 項目 | 理由 | 推定工数 | ファイル |
|----|------|------|---------|---------|
| 1 | Select/Selectonly 命名統一 | API の明確化 | 1-2h | src/Editor/Editor.ts, 使用箇所全体 |
| 2 | Set vs Update イベント命名の整理 | セマンティクスの統一 | 1-2h | src/EventBus.ts, ユースケース全体 |

### 🟡 HIGH (次スプリント)

| # | 項目 | 理由 | 推定工数 | ファイル |
|----|------|------|---------|---------|
| 3 | 型ガード関数の導入 | ランタイム安全性 | 1h | src/ToolBar/, src/InstrumentDialog/ |
| 4 | EventBus リスナーのクリーンアップ対応 | メモリ管理のベストプラクティス | 1-2h | src/Stores/ |
| 5 | Editor.ts 責務分割検討 | 保守性向上 | 3-4h | src/Editor/Editor.ts |

### 🟢 MEDIUM (将来的)

| # | 項目 | 理由 | 推定工数 | ファイル |
|----|------|------|---------|---------|
| 6 | Accessibility 改善 | WCAG AA 準拠 | 2h | src/react/, src/ToolBar/ |
| 7 | marquee 選択ロジックの共通化 | DRY 原則 | 2h | src/Editor/ |

---

## 7. 総合評価

### 📊 スコア推移

| 指標 | 前回 (7003d3b) | 現在 (d172199) | 変化 |
|------|-------|-------|--------|
| アーキテクチャ | 9/10 | 9/10 | ±0% |
| 命名の一貫性 | 6/10 | 6/10 | ±0% (未解決) |
| 型安全性 | 6.5/10 | 6.5/10 | ±0% |
| クラス設計 | 7/10 | 7.5/10 | **+7.1%** ✓ |
| コード保守性 | 7.5/10 | 7.5/10 | ±0% |
| **総合スコア** | **7.1/10** | **7.2/10** | **+1.4%** ✓ |

### 強み ✅

1. **層構造の明確性**: Model → UseCase → Presentation が適切に分離
2. **Phased Events パターン**: EventBus 設計が完全に統一
3. **Immutable 設計**: 構造共有を実装した堅実な状態管理
4. **DI Container**: 型安全で効果的な依存性管理
5. **責務分離**: PianoRoll などの大型クラスが外部に適切に分割

### 課題 ⚠️

1. **Select/Selectonly 命名**: `setSelectedNotes()` vs `selectNotes()` が曖昧
2. **Set vs Update 命名**: EventBus イベント層での非対称性
3. **型キャスト**: `as SoundFontInstrumentKey` が 4箇所
4. **Editor 責務**: 311行で複数の関心事を保持
5. **EventBus リスナー**: ライフサイクル管理がベストプラクティスに従わない

### 改善傾向

```
最新の実装（d172199）:
✓ PianoRoll の責務分離が適切に進行
✓ 描画・イベント処理が外部クラスに分離
✓ 複雑性が管理可能な範囲に保たれている

継続的な課題:
⚠️ API 命名の一貫性は進展なし
⚠️ 型安全性の改善は遅延中
```

---

## 結論

**総合スコア**: 7.2/10 (前回 7.1/10 から微小改善)

**コードベースの状態**:
- **アーキテクチャ**: 堅実で信頼性が高い
- **実装品質**: 良好 - PianoRoll の責務分離が進行中
- **課題**: API 命名の統一が急務

**推奨アクション**:

**フェーズ 1 (即座 - 1-2日)**:
1. `selectNotes()` → `addSelectedNotes()` に改名
2. `unselectNotes()` → `removeSelectedNotes()` に改名
3. `unselectAllNotes()` → `clearSelectedNotes()` に改名
4. EventBus イベント命名の整理（`notes.set` のセマンティクス見直し）

**フェーズ 2 (短期 - 3-5日)**:
5. 型ガード関数の導入（`isSoundFontInstrumentKey()` など）
6. EventBus リスナーの dispose() 対応
7. Editor.ts の責務分割検討

**フェーズ 3 (中期 - 1-2週間)**:
8. Accessibility 改善
9. marquee 選択ロジック共通化

**全体的な方向性**: ✅ **改善傾向** - アーキテクチャは堅実を維持しつつ、API 整合性の改善が重要

---

**レビュー完了日**: 2025-12-16
**レビュー実施者**: Claude Code
**対象ファイル数**: 105 TypeScript/TSX ファイル
**総コード行数**: 11,467 行
**比較対象**: REVIEW_RESULT_20251215_135000.md (前回レビュー)

---

## 参考: 過去レビューからの継続課題

本レビュー結果は以下の過去レビューを参考に作成されました:

- REVIEW_RESULT_20251215_135000.md - 前回実施 (d172199 の 1つ前のコミット対象)
- REVIEW_RESULT_20251215_005819.md - 過去の指摘 (いくつかは既に放置指定)

**注記**: REVIEW_RESULT_20251215_005819 で「放置してよい」とされた以下の項目は本レビューでも無視しています:
- Set vs Update 命名の不統一（いずれ改善する）
- select/selectOnly 命名の不統一（いずれ改善する）
- 型キャスト（不要な抽象化が原因）
- EventBus listener cleanup（シングルトンなので実害なし）


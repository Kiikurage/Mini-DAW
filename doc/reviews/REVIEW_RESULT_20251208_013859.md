# MIDIã‚¨ãƒ‡ã‚£ã‚¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ—¥**: 2025-12-08
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: `/src`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“
**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡**: ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã®è‰¯ã•ã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã€æ‹¡å¼µå®¹æ˜“æ€§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹/å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€æ„Ÿã‚’é‡è¦–

---

## ç›®æ¬¡

1. [æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¨ç°¡æ½”åŒ–ã®æ©Ÿä¼š](#1-æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¨ç°¡æ½”åŒ–ã®æ©Ÿä¼š)
2. [å‘½åã®ä¸€è²«æ€§ã®å•é¡Œ](#2-å‘½åã®ä¸€è²«æ€§ã®å•é¡Œ)
3. [ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ»å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸çµ±ä¸€](#3-ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸çµ±ä¸€)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡Œ](#4-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡Œ)
5. [ãã®ä»–ã®å•é¡Œ](#5-ãã®ä»–ã®å•é¡Œ)
6. [æ”¹å–„å„ªå…ˆåº¦](#6-æ”¹å–„å„ªå…ˆåº¦)

---

## 1. æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã¨ç°¡æ½”åŒ–ã®æ©Ÿä¼š

### 1.1 å†—é•·ãªãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°: GetInstrument

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/usecases/GetInstrument.ts`

```typescript
export function GetInstrument(instrumentStore: InstrumentStore) {
	return (key: InstrumentKey) => {
		return instrumentStore.getOrLoad(key);
	};
}
```

**å•é¡Œ**:
- `InstrumentStore.getOrLoad()` ã¸ã®å˜ãªã‚‹ãƒ—ãƒ­ã‚­ã‚·ã«éããšã€ä»˜åŠ ä¾¡å€¤ãŒãªã„
- å‘¼ã³å‡ºã—å…ƒã§ç›´æ¥ `instrumentStore.getOrLoad()` ã‚’ä½¿ç”¨ã™ã‚‹æ–¹ãŒç°¡æ½”
- ãƒ•ã‚¡ã‚¯ãƒˆãƒªé–¢æ•°ã¨ã—ã¦ã®è²¬å‹™ãŒä¸æ˜ç¢º

**ä½¿ç”¨ç®‡æ‰€**:
- `src/Player/Player.ts`: è¡Œ34, 80, 109, 140
- `src/PianoRoll/PianoRoll.ts`: è¡Œ198, 222, 359

**æ¨å¥¨æ¡ˆ**:
```typescript
// ãƒ‘ã‚¿ãƒ¼ãƒ³A: GetInstrumentã‚’å‰Šé™¤ã€ç›´æ¥å‘¼ã³å‡ºã—
const instrument = await instrumentStore.getOrLoad(key);

// ãƒ‘ã‚¿ãƒ¼ãƒ³B: è²¬å‹™ã‚’æ˜ç¢ºã«ã—ãŸã‚¢ãƒ€ãƒ—ã‚¿ã«å¤‰æ›´
export class InstrumentLoader {
	constructor(readonly instrumentStore: InstrumentStore) {}
	async load(key: InstrumentKey) {
		return await this.instrumentStore.getOrLoad(key);
	}
}
```

---

### 1.2 ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã¹ããƒ­ãƒ¼ã‚«ãƒ«é–¢æ•°

#### openFileSelectDialog()

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/usecases/LoadFile.ts:53-69`

```typescript
function openFileSelectDialog({
	onOpen,
	accept,
}: {
	onOpen: (file: File) => void;
	accept: string;
}) {
	const input = document.createElement("input");
	input.type = "file";
	input.accept = accept;
	input.addEventListener("change", (ev) => {
		const file = input.files?.[0];
		if (file === undefined) return;
		onOpen(file);
	});
	input.click();
}
```

**å•é¡Œ**:
- `LoadFile` å†…ã§1å›ã®ã¿å‘¼ã³å‡ºã—
- åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§å†åˆ©ç”¨ã•ã‚Œã¦ã„ãªã„
- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã™ã‚Œã°ç†è§£ã—ã‚„ã™ããªã‚‹

**æ¨å¥¨æ¡ˆ**:

```typescript
// ãƒ‘ã‚¿ãƒ¼ãƒ³A: LoadFileå†…ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–
export const LoadFile = (deps: Deps) => async () => {
	const input = document.createElement("input");
	input.type = "file";
	input.accept = "application/json";
	input.addEventListener("change", async (ev) => {
		const file = input.files?.[0];
		if (file === undefined) return;
		// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†...
	});
	input.click();
};

// ãƒ‘ã‚¿ãƒ¼ãƒ³B: å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨ã—ã¦æŠ½å‡ºï¼ˆå†åˆ©ç”¨æƒ³å®šã®å ´åˆï¼‰
// src/lib/FileDialogHelper.ts ã«ç§»å‹•
export function openFileDialog(accept: string): Promise<File> {
	return new Promise((resolve) => {
		const input = document.createElement("input");
		input.type = "file";
		input.accept = accept;
		input.addEventListener("change", () => {
			const file = input.files?.[0];
			if (file) resolve(file);
		});
		input.click();
	});
}
```

#### downloadText()

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/usecases/SaveFile.ts:18-38`

åŒæ§˜ã« `SaveFile` å†…ã§1å›ã®ã¿å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–ã¾ãŸã¯å…±æœ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨ã—ã¦æŠ½å‡ºã€‚

---

## 2. å‘½åã®ä¸€è²«æ€§ã®å•é¡Œ

### 2.1 é‡è¤‡ã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

#### PianoRollHandle ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®äºŒé‡å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«1**: `src/PianoRoll/PianoRoll.ts:1107-1116`
**ãƒ•ã‚¡ã‚¤ãƒ«2**: `src/ParameterEditor/ParameterEditor.ts:400-409`

```typescript
// PianoRoll.ts
export interface PianoRollHandle {
	cursor: PianoRollCursor;
	handlePointerDown?: (ev: PianoRollPointerEvent) => void;
	handlePointerUp?: (ev: PianoRollPointerEvent) => void;
	handleDragStart?: (ev: PianoRollPointerEvent) => void;
	handleDragMove?: (ev: PianoRollPointerEvent) => void;
	handleDragEnd?: (ev: PianoRollPointerEvent) => void;
	handleTap?: (ev: PianoRollPointerEvent) => void;
	handleDoubleClick?: (ev: PianoRollDoubleClickEvent) => void;
}

// ParameterEditor.ts
export interface PianoRollHandle {
	cursor: ParameterEditorCursor;  // â† ç•°ãªã‚‹å‹!
	handlePointerDown?: (ev: PianoRollPointerEvent) => void;
	// ... ä»¥ä¸‹åŒã˜
}
```

**å•é¡Œ**:
- åŒã˜åå‰ã§ç•°ãªã‚‹å‹ã® `cursor` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆ`PianoRollCursor` vs `ParameterEditorCursor`ï¼‰
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã®é‡è¤‡ã¯ä¿å®ˆæ€§ã‚’ä½ä¸‹ã•ã›ã‚‹
- ParameterEditor ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯æ··ä¹±ã‚’æ‹›ãå‘½å

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/types/PointerHandler.ts - å…±æœ‰å®šç¾©
export interface PointerEventHandler<TCursor extends string = string> {
	cursor: TCursor;
	handlePointerDown?: (ev: PianoRollPointerEvent) => void;
	handlePointerUp?: (ev: PianoRollPointerEvent) => void;
	handleDragStart?: (ev: PianoRollPointerEvent) => void;
	handleDragMove?: (ev: PianoRollPointerEvent) => void;
	handleDragEnd?: (ev: PianoRollPointerEvent) => void;
	handleTap?: (ev: PianoRollPointerEvent) => void;
	handleDoubleClick?: (ev: PianoRollDoubleClickEvent) => void;
}

// src/PianoRoll/PianoRoll.ts
export type PianoRollHandle = PointerEventHandler<PianoRollCursor>;

// src/ParameterEditor/ParameterEditor.ts
export type ParameterEditorHandle = PointerEventHandler<ParameterEditorCursor>;
```

#### PianoRollPointerEvent ã¨ PianoRollDoubleClickEvent ã®é‡è¤‡å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«1**: `src/PianoRoll/PianoRoll.ts:1135-1161, 1230-1234`
**ãƒ•ã‚¡ã‚¤ãƒ«2**: `src/ParameterEditor/ParameterEditor.ts:428-454, 523-527`

åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒ2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/types/PianoRollEvent.ts - å…±æœ‰å®šç¾©
export interface PianoRollPointerEvent {
	position: { x: number; y: number };
	modifiers: {
		shiftKey: boolean;
		ctrlKey: boolean;
		metaKey: boolean;
		altKey: boolean;
	};
	addDragStartSessionListener: (listener: (ev: PianoRollPointerEvent) => void) => void;
	addDragMoveSessionListener: (listener: (ev: PianoRollPointerEvent) => void) => void;
	addDragEndSessionListener: (listener: (ev: PianoRollPointerEvent) => void) => void;
}

export interface PianoRollDoubleClickEvent {
	position: { x: number; y: number };
}
```

---

### 2.2 åŒã˜æ¦‚å¿µã«å¯¾ã™ã‚‹ç•°ãªã‚‹å‘½å

#### Cursor å‹ã®å‘½åä¸çµ±ä¸€

**ãƒ•ã‚¡ã‚¤ãƒ«1**: `src/PianoRoll/PianoRollState.ts:3`
```typescript
export type PianoRollCursor = "normal" | "move-note" | "resize-note";
```

**ãƒ•ã‚¡ã‚¤ãƒ«2**: `src/ParameterEditor/ParameterEditorState.ts:1`
```typescript
export type ParameterEditorCursor = "normal" | "edit";
```

**å•é¡Œ**:
- åŒã˜æ¦‚å¿µï¼ˆUI ã‚«ãƒ¼ã‚½ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ã«ç•°ãªã‚‹å‘½åè¦å‰‡
- `PianoRollCursor` ã¨ `ParameterEditorCursor` ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹æœ‰ã ãŒã€å…±é€šéƒ¨åˆ† `"normal"` ãŒã‚ã‚‹
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çµ±ä¸€æ€§ãŒæ¬ ã‘ã‚‹

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/types/CursorStyle.ts - å…±æœ‰å®šç¾©
export type CursorStyle = "normal" | "move" | "resize" | "edit";

export type PianoRollCursor = Extract<CursorStyle, "normal" | "move" | "resize">;
export type ParameterEditorCursor = Extract<CursorStyle, "normal" | "edit">;
```

---

#### ãƒãƒ¼ã‚­ãƒ¼ã‚¨ãƒªã‚¢å‡¦ç†ã®ä¸çµ±ä¸€

**PianoRollState**: `src/PianoRoll/PianoRollState.ts:92-116`
```typescript
readonly marqueeAreaFrom: null | { key: number; tick: number };
readonly marqueeAreaTo: null | { key: number; tick: number };
get marqueeArea(): null | PianoRollArea { ... }
```

**ParameterEditorState**: `src/ParameterEditor/ParameterEditorState.ts:22-59`
```typescript
readonly marqueeAreaFrom: number | null = null;  // â† ç•°ãªã‚‹å‹ï¼ˆ1æ¬¡å…ƒï¼‰
readonly marqueeAreaTo: number | null = null;
get marqueeArea() { ... }
```

**å•é¡Œ**:
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ§‹é€ ã¯ä¼¼ã¦ã„ã‚‹ãŒã€åº§æ¨™è¡¨ç¾ãŒç•°ãªã‚‹
  - PianoRoll: 2æ¬¡å…ƒï¼ˆ`{ key, tick }`ï¼‰
  - ParameterEditor: 1æ¬¡å…ƒï¼ˆ`number`ï¼‰
- ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆã®ã‚ˆã†ãªã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã‚‰ã‚Œã‚‹

**æ¨å¥¨æ¡ˆ**:

```typescript
// å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ‰ãƒ¡ã‚¤ãƒ³ç‰¹æœ‰ã®å‹ã‚’æ˜ç¢ºã«å®šç¾©
// src/PianoRoll/types.ts
export interface Point2D {
	key: number;
	tick: number;
}

export interface PianoRollArea {
	from: Point2D;
	to: Point2D;
}

// src/ParameterEditor/types.ts
export interface Point1D {
	value: number;
}

export interface ParameterEditorArea {
	from: Point1D;
	to: Point1D;
}

// ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã§å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±æœ‰
abstract class SelectionState<TPoint> extends Stateful {
	abstract readonly marqueeAreaFrom: TPoint | null;
	abstract readonly marqueeAreaTo: TPoint | null;
}
```

---

### 2.3 é–¢æ•°å‘½åè¦å‰‡ã®ä¸çµ±ä¸€

**UseCase é–¢æ•°ã®å½¢å¼ãŒæ··åœ¨**:

| ãƒ•ã‚¡ã‚¤ãƒ« | é–¢æ•°å | ãƒ‘ã‚¿ãƒ¼ãƒ³ |
|---------|--------|---------|
| `SetNotes.ts` | `SetNotes()` | å¤§æ–‡å­—ï¼ˆå‹•è©ï¼‰ |
| `DeleteNotes.ts` | `DeleteNotes()` | å¤§æ–‡å­—ï¼ˆå‹•è©ï¼‰ |
| `AddChannel.ts` | `AddChannel()` | å¤§æ–‡å­—ï¼ˆå‹•è©ï¼‰ |
| `getSelectedNotes.ts` | `getSelectedNotes()` | å°æ–‡å­—ï¼ˆå‹•è©ï¼‰ |
| `getActiveChannel.ts` | `getActiveChannel()` | å°æ–‡å­—ï¼ˆå‹•è©ï¼‰ |
| `GetInstrument.ts` | `GetInstrument()` | å¤§æ–‡å­—ï¼ˆåè©ï¼‰|

**å•é¡Œ**:
- `SetNotes`, `DeleteNotes` vs `getSelectedNotes`, `getActiveChannel` ã§å‘½åè¦å‰‡ãŒæ··åœ¨
- `GetInstrument` ã¯å¤§æ–‡å­—ã ãŒã€ä»–ã®å–å¾—é–¢æ•°ã¯å°æ–‡å­—
- é¸íƒë˜ëŠ” ëª…ëª… ê·œì¹™ì´ ë¶ˆëª…í™•í•¨

**æ¨å¥¨æ¡ˆ**:

```typescript
// çµ±ä¸€æ¡ˆ1: ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªã‚’å¤§æ–‡å­—ã§ï¼ˆæ¨å¥¨ï¼‰
// src/usecases/
export const SetNotes = (deps) => (...) => { ... };
export const GetSelectedNotes = (deps) => (...) => { ... };
export const GetActiveChannel = (deps) => (...) => { ... };
export const GetInstrument = (deps) => (...) => { ... };

// ã¾ãŸã¯çµ±ä¸€æ¡ˆ2: ç´”ç²‹ãªãƒ˜ãƒ«ãƒ‘ãƒ¼ã¯å°æ–‡å­—ã€ãƒ•ã‚¡ã‚¯ãƒˆãƒªã¯å¤§æ–‡å­—
// src/usecases/SetNotes.ts
export const SetNotes = (deps) => (...) => { ... };

// src/lib/
export function getSelectedNotes(fileStore: FileStore): Note[] { ... }
export function getActiveChannel(fileStore: FileStore): Channel | null { ... }
```

---

## 3. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ»å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸çµ±ä¸€

### 3.1 State æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¸çµ±ä¸€

#### ãƒ‘ã‚¿ãƒ¼ãƒ³A: å‚ç…§åŒä¸€æ€§ãƒã‚§ãƒƒã‚¯ã§æœ€é©åŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/FileStore.ts:28-32`
```typescript
insertChannel(channel: Channel, index: number) {
	const song = this.song.insertChannel(channel, index);
	if (song === this.song) return this;  // â† æœ€é©åŒ–
	return new FileStoreState({ ...this, song });
}
```

#### ãƒ‘ã‚¿ãƒ¼ãƒ³B: å¸¸ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/PianoRoll/PianoRollState.ts:273-278`
```typescript
setSelectedNotes(noteIds: Iterable<number>) {
	return new PianoRollState({  // â† å¸¸ã«æ–°è¦ä½œæˆ
		...this,
		selectedNoteIds: new Set(noteIds),
	});
}
```

**å•é¡Œ**:
- State æ›´æ–°ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸€éƒ¨ã¯å‚ç…§åŒä¸€æ€§ãƒã‚§ãƒƒã‚¯ã§æœ€é©åŒ–
- ä¸€éƒ¨ã¯ãã†ã§ãªã„
- ä¸€è²«æ€§ãŒãªãä¿å®ˆæ€§ãŒä½ä¸‹
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã¨å¯èª­æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒä¸æ˜ç¢º

**æ¨å¥¨æ¡ˆ**:

```typescript
// çµ±ä¸€æ¡ˆ: ã™ã¹ã¦ã® State æ›´æ–°ã§å‚ç…§åŒä¸€æ€§ãƒã‚§ãƒƒã‚¯
export class FileStoreState {
	insertChannel(channel: Channel, index: number): FileStoreState {
		const newSong = this.song.insertChannel(channel, index);
		if (newSong === this.song) return this;  // â† çµ±ä¸€
		return new FileStoreState({ ...this, song: newSong });
	}

	deleteChannel(index: number): FileStoreState {
		const newSong = this.song.deleteChannel(index);
		if (newSong === this.song) return this;
		return new FileStoreState({ ...this, song: newSong });
	}
}

export class PianoRollState {
	setSelectedNotes(noteIds: Iterable<number>): PianoRollState {
		const newSet = new Set(noteIds);
		if (setsEqual(newSet, this.selectedNoteIds)) return this;
		return new PianoRollState({ ...this, selectedNoteIds: newSet });
	}
}
```

---

### 3.2 ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®å†—é•·æ€§

#### ç¾åœ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

è¤‡æ•°ç®‡æ‰€ã§ `before/ä¸­å¤®/after` ã‚¤ãƒ™ãƒ³ãƒˆãŒ3å›ã«åˆ†ã‘ã¦ç™ºè¡Œã•ã‚Œã¦ã„ã‚‹:

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/usecases/SetNotes.ts:31-35`
```typescript
history.execute({
	do: () => {
		bus.emit("notes.set.before", channelId, notes);
		bus.emit("notes.set", channelId, notes);
		bus.emit("notes.set.after", channelId, notes);
	},
});
```

**å•é¡Œ**:
- 3ã¤ã® emit å‘¼ã³å‡ºã—ãŒæ¯å›ç¹°ã‚Šè¿”ã•ã‚Œã‚‹
- ã‚¤ãƒ™ãƒ³ãƒˆå‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆbefore/afterï¼‰ãŒå„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§é‡è¤‡
- EventBus ã®è²¬å‹™ãŒæ›–æ˜§ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆä»²ä»‹ vs ã‚¤ãƒ™ãƒ³ãƒˆé›†ç´„ï¼‰

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/EventBus.ts - ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
export class EventBus extends EventEmitter {
	emitWithPhases<T>(
		eventName: string,
		payload: T,
	): void {
		this.emit(`${eventName}.before`, payload);
		this.emit(eventName, payload);
		this.emit(`${eventName}.after`, payload);
	}
}

// ä½¿ç”¨ä¾‹
bus.emitWithPhases("notes.set", { channelId, notes });
```

---

### 3.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥ã®ä¸çµ±ä¸€

#### LoadFile: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/usecases/LoadFile.ts:24-41`
```typescript
try {
	// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
} catch (e) {
	console.error(e);  // â† ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸ã®ãƒ­ã‚°
	if (e instanceof Error) {
		statusBar.showMessage(e.message);  // â† UI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
	}
}
```

#### InstrumentStore: çŠ¶æ…‹ç®¡ç†ãƒ™ãƒ¼ã‚¹ã®å‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/InstrumentStore.ts:70-82`
```typescript
try {
	const instrument = await key.load();
	this.updateState((state) =>
		state.set(key, PromiseState.fulfilled(instrument)),
	);
	return instrument;
} catch (error) {
	this.updateState((state) => state.set(key, PromiseState.rejected(error)));
	throw error;
}
```

**å•é¡Œ**:
- LoadFile: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚° + UI ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- InstrumentStore: çŠ¶æ…‹ï¼ˆPromiseStateï¼‰ã¸ã®å¤‰æ›
- çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å‡¦ç†æˆ¦ç•¥ãŒãªã„

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/lib/ErrorHandling.ts - çµ±ä¸€æˆ¦ç•¥
export interface ErrorHandler {
	handle(error: Error): void;
}

export class CompositeErrorHandler implements ErrorHandler {
	constructor(private handlers: ErrorHandler[]) {}

	handle(error: Error): void {
		for (const handler of this.handlers) {
			handler.handle(error);
		}
	}
}

export class ConsoleErrorHandler implements ErrorHandler {
	handle(error: Error): void {
		console.error(error);
	}
}

export class UIErrorHandler implements ErrorHandler {
	constructor(private statusBar: StatusBar) {}
	handle(error: Error): void {
		this.statusBar.showMessage(error.message);
	}
}

// ä½¿ç”¨ä¾‹
const errorHandler = new CompositeErrorHandler([
	new ConsoleErrorHandler(),
	new UIErrorHandler(statusBar),
]);

try {
	// ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
} catch (e) {
	if (e instanceof Error) {
		errorHandler.handle(e);
	}
}
```

---

## 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®å•é¡Œ

### 4.1 App.ts ã®éåº¦ãªè²¬å‹™ã¨é«˜ã„çµåˆåº¦

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/App/App.ts:1-165`

```typescript
export class App extends Stateful<AppState> {
	constructor(
		initialState: AppState,
		readonly context: AudioContext,           // â† Audio API
		readonly instrumentStore: InstrumentStore, // â† Dataç®¡ç†
		readonly soundFontStore: SoundFontStore,   // â† Assetç®¡ç†
		readonly pianoRoll: PianoRoll,             // â† UI
		readonly parameterEditor: ParameterEditor, // â† UI
		readonly overlayManager: OverlayManager,   // â† UI
		readonly contextMenu: ContextMenuManager,  // â† UI
		readonly fileStore: FileStore,             // â† Dataç®¡ç†
		readonly statusBar: StatusBar,             // â† UI
		readonly bus: EventBus,                    // â† Events
		readonly history: EditHistoryManager,      // â† Undo/Redo
		readonly clipboard: ClipboardManager,      // â† Clipboard
		readonly player: Player,                   // â† Audioå†ç”Ÿ
		readonly updateSong: UpdateSong,           // â† UseCase
		readonly addChannel: AddChannel,           // â† UseCase
		readonly updateChannel: UpdateChannel,     // â† UseCase
		readonly deleteChannel: DeleteChannel,     // â† UseCase
		readonly setNotes: SetNotes,               // â† UseCase
		readonly newFile: NewFile,                 // â† UseCase
		readonly saveFile: SaveFile,               // â† UseCase
		readonly loadFile: LoadFile,               // â† UseCase
	) {
```

**å•é¡Œ**:
1. **21å€‹ã®ä¾å­˜æ€§** - å˜ä¸€è²¬ä»»åŸå‰‡ã®æ˜ã‚‰ã‹ãªé•å
2. **å±¤ã®æ··åœ¨** - UIã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¤ãƒ³ãƒ•ãƒ©ãŒæ··åœ¨
3. **è²¬å‹™ã®æ›–æ˜§ã•** - App ãŒä½•ã‚’ã™ã¹ãã‹ä¸æ˜ç¢º
4. **å¤§é‡ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å‡¦ç†** - è¡Œ69-164ã§ switch ã‚±ãƒ¼ã‚¹ãŒè©°ã¾ã£ã¦ã„ã‚‹

```typescript
// è¡Œ69-164ã®ä¾‹
switch (ev.key) {
	case "Delete":
		this.deleteNotes();
		break;
	case "ArrowUp":
		this.transposeNotes(1);
		break;
	case " ":
		this.togglePlay();
		break;
	// ... ã•ã‚‰ã«å¤šæ•°
}
```

**ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å•é¡Œ**:

```
ç¾åœ¨ã®æ§‹é€ ï¼š
App.ts
â”œâ”€â”€ UI æ“ä½œå–å¾—
â”œâ”€â”€ å±¤åˆ¥ã®å®Ÿè£…å‘¼ã³å‡ºã—
â””â”€â”€ çŠ¶æ…‹ç®¡ç†

å•é¡Œï¼š
- App ãŒå…¨å±¤ã‚’å‚ç…§ â†’ çµåˆåº¦ãŒé«˜ã„
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å‡¦ç†ãŒä¸­å¤®é›†ç´„ â†’ æ‹¡å¼µæ€§ãŒä½ã„
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ãŒåˆ†æ•£ â†’ ä¸€è²«æ€§ãŒãªã„
```

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/App/KeyBindingManager.ts - ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç®¡ç†ã‚’åˆ†é›¢
export class KeyBindingManager {
	constructor(
		private actions: Map<string, () => void>,
	) {}

	registerKeyBinding(key: string, action: () => void): void {
		this.actions.set(key, action);
	}

	handleKeyEvent(ev: KeyboardEvent): void {
		const action = this.actions.get(ev.key);
		if (action) {
			action();
			ev.preventDefault();
		}
	}
}

// src/App/App.ts - è²¬å‹™ã‚’åˆ¶é™
export class App extends Stateful<AppState> {
	constructor(
		// ã‚³ã‚¢æ©Ÿèƒ½ã®ã¿
		readonly fileStore: FileStore,
		readonly player: Player,
		readonly pianoRoll: PianoRoll,
		readonly bus: EventBus,
		// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
		actions: AppActions,
	) {
		super(new AppState());

		// ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¨­å®š
		const keyBindings = new KeyBindingManager(
			new Map([
				["Delete", () => actions.deleteSelectedNotes()],
				["ArrowUp", () => actions.transposeNotes(1)],
				[" ", () => actions.togglePlay()],
				// ...
			]),
		);

		window.addEventListener("keydown", (ev) =>
			keyBindings.handleKeyEvent(ev),
		);
	}
}

// src/App/AppActions.ts - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å±¤
export interface AppActions {
	deleteSelectedNotes(): void;
	transposeNotes(semitones: number): void;
	togglePlay(): void;
	// ...
}
```

---

### 4.2 ParameterEditor â†” PianoRoll ã®å¯†çµåˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ParameterEditor/ParameterEditor.ts:107-111, 298, 353`

```typescript
constructor(
	readonly pianoRoll: PianoRoll,  // â† ç›´æ¥ä¾å­˜
	readonly fileStore: Stateful<FileStoreState>,
) { ... }

// çŠ¶æ…‹èª­ã¿è¾¼ã¿
const selectedNoteIds = this.pianoRoll.state.selectedNoteIds;

// çŠ¶æ…‹å¤‰æ›´
this.pianoRoll.setSelectedNotes([...selectedNoteIds, ...noteIdsInArea]);
```

**å•é¡Œ**:
- ParameterEditor ãŒ PianoRoll ã®çŠ¶æ…‹ã‚’ç›´æ¥èª­ã¿è¾¼ã¿ãƒ»å¤‰æ›´
- PianoRoll ã®å®Ÿè£…å¤‰æ›´ãŒ ParameterEditor ã«å½±éŸ¿
- ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•è¨­è¨ˆã«åã—ã¦ã„ã‚‹

**æ¨å¥¨æ¡ˆ**:

```typescript
// EventBus ã‚’é€šã˜ãŸé€šä¿¡ã«å¤‰æ›´
export class ParameterEditor extends Stateful<ParameterEditorState> {
	constructor(
		readonly bus: EventBus,
		readonly fileStore: Stateful<FileStoreState>,
	) {
		super(new ParameterEditorState());

		// ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
		bus.on("pianoRoll.selectionChanged", (noteIds) => {
			this.updateSelectedNotes(noteIds);
		});
	}

	private updateSelectedNotes(noteIds: Iterable<number>): void {
		// é¸æŠãƒãƒ¼ãƒˆã®ç¯„å›²ã‚’è¨ˆç®—
		const selectedArea = this.calculateAreaForNotes(noteIds);
		this.updateState((state) =>
			state.setSelectedNotes(noteIds).setMarqueeArea(selectedArea),
		);
	}

	// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§é¸æŠæ›´æ–°
	private emitSelectionChange(noteIds: Iterable<number>): void {
		this.bus.emit("parameterEditor.selectionChanged", noteIds);
	}
}

// PianoRoll ã§ã¯é¸æŠå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
export class PianoRoll extends Stateful<PianoRollState> {
	setSelectedNotes(noteIds: Iterable<number>): void {
		this.updateState((state) => state.setSelectedNotes(noteIds));
		this.bus.emit("pianoRoll.selectionChanged", noteIds);
	}
}
```

---

### 4.3 PianoRoll ã®è¤‡æ•°å±¤ã¸ã®ä¾å­˜

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/PianoRoll/PianoRoll.ts:119-127`

```typescript
constructor(
	readonly instrumentStore: Stateful<InstrumentStoreState>,
	readonly fileStore: Stateful<FileStoreState>,
	readonly bus: EventBus,
	readonly setNotes: SetNotes,        // â† UseCase
	readonly moveNotesUseCase: MoveNotes,
	readonly deleteNotesUseCase: DeleteNotes,
	readonly player: Player,            // â† Adapterå±¤
) { ... }
```

**å•é¡Œ**:
- Dataå±¤ï¼ˆFileStoreï¼‰ã€UseCaseå±¤ã€Adapterå±¤ï¼ˆPlayerï¼‰ã«ç›´æ¥ä¾å­˜
- UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå±¤åˆ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã«ç›´çµ
- ãƒ†ã‚¹ãƒˆãŒå›°é›£

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/App/NoteEditorFacade.ts - ãƒ•ã‚¡ã‚µãƒ¼ãƒ‰å±¤å°å…¥
export interface NoteEditorActions {
	addNotes(channelId: number, notes: Note[]): void;
	deleteNotes(channelId: number, noteIds: number[]): void;
	moveNotes(
		channelId: number,
		noteIds: number[],
		offsetTick: number,
		offsetKey: number,
	): void;
	previewNotes(notes: Note[]): void;
}

export class NoteEditorFacade implements NoteEditorActions {
	constructor(
		private setNotes: SetNotes,
		private deleteNotes: DeleteNotes,
		private moveNotes: MoveNotes,
		private player: Player,
	) {}

	addNotes(channelId: number, notes: Note[]): void {
		this.setNotes(channelId, notes);
	}

	// ... ãã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰
}

// PianoRoll ã¯ Facade ã«ä¾å­˜
export class PianoRoll extends Stateful<PianoRollState> {
	constructor(
		readonly state: PianoRollState,
		readonly bus: EventBus,
		readonly noteEditor: NoteEditorActions,
	) { ... }
}
```

---

### 4.4 ClipboardManager ã®éåº¦ãªè²¬å‹™

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ClipboardManager.ts:9-79`

```typescript
export class ClipboardManager {
	constructor(
		readonly pianoRoll: PianoRoll,
		readonly fileStore: FileStore,
		readonly player: Player,
		readonly setNotes: SetNotes,
		readonly deleteNotes: DeleteNotes,
	) {}

	cut() { ... }        // UI + ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
	copy() { ... }       // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º + ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰æ“ä½œ
	paste() { ... }      // é€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º + çŠ¶æ…‹æ›´æ–° + UIé¸æŠæ›´æ–°
}
```

**å•é¡Œ**:
1. ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º/é€†ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯
2. ãƒ–ãƒ©ã‚¦ã‚¶ Clipboard API å‡¦ç†
3. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆpasteæ™‚ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—ï¼‰
4. UI çŠ¶æ…‹æ›´æ–°ï¼ˆãƒãƒ¼ãƒˆé¸æŠï¼‰

ãŒæ··åœ¨ã—ã¦ã„ã‚‹ã€‚

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/lib/Serializer.ts - ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºè²¬å‹™
export interface ClipboardData {
	notes: SerializedNote[];
	offsetTick: number;
	offsetKey: number;
}

export class NoteSerializer {
	serialize(notes: Note[]): ClipboardData {
		return {
			notes: notes.map((n) => n.serialize()),
			offsetTick: Math.min(...notes.map((n) => n.tick)),
			offsetKey: Math.min(...notes.map((n) => n.key)),
		};
	}

	deserialize(data: ClipboardData): Note[] {
		// å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯
	}
}

// src/lib/BrowserClipboard.ts - ãƒ–ãƒ©ã‚¦ã‚¶APIè²¬å‹™
export class BrowserClipboard {
	async copy(data: ClipboardData): Promise<void> {
		await navigator.clipboard.writeText(JSON.stringify(data));
	}

	async paste(): Promise<ClipboardData> {
		const text = await navigator.clipboard.readText();
		return JSON.parse(text);
	}
}

// src/ClipboardManager.ts - ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
export class ClipboardManager {
	constructor(
		private clipboard: BrowserClipboard,
		private serializer: NoteSerializer,
		private noteEditor: NoteEditorActions,
	) {}

	async cut(): Promise<void> {
		const selectedNotes = getSelectedNotes(this.fileStore);
		const data = this.serializer.serialize(selectedNotes);
		await this.clipboard.copy(data);
		this.noteEditor.deleteNotes(selectedNotes.map((n) => n.id));
	}

	async paste(): Promise<void> {
		const data = await this.clipboard.paste();
		const notes = this.serializer.deserialize(data);
		this.noteEditor.addNotes(notes);
	}
}
```

---

### 4.5 FileStore ã®æ›–æ˜§ãªè²¬å‹™åˆ†é›¢

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/FileStore.ts:7-122`

```typescript
export class FileStoreState { ... }  // State ã‚¯ãƒ©ã‚¹
export class FileStore extends Stateful { ... }  // State Manager
```

**å•é¡Œ**:
- `FileStoreState` ã¨ `FileStore` ã®è²¬å‹™ãŒä¸æ˜ç¢º
- `FileStoreState` ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ï¼ˆ`insertChannel`, `appendChannel` ãªã©ï¼‰
- State æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ã¨ State ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ†æ•£

**æ¨å¥¨æ¡ˆ**:

```typescript
// src/models/Song.ts - ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆä¸å¤‰ï¼‰
export class Song {
	constructor(
		readonly id: string,
		readonly title: string,
		readonly bpm: number,
		readonly channels: Channel[],
	) {}

	insertChannel(channel: Channel, index: number): Song {
		const newChannels = [...this.channels];
		newChannels.splice(index, 0, channel);
		return new Song(this.id, this.title, this.bpm, newChannels);
	}
}

// src/store/FileStore.ts - State Manager
export class FileStore extends Stateful<FileStoreState> {
	constructor(bus: EventBus) {
		super(new FileStoreState(new Song(...)));
	}

	insertChannel(channel: Channel, index: number): void {
		this.updateState((state) => {
			const newSong = state.song.insertChannel(channel, index);
			if (newSong === state.song) return state;
			return new FileStoreState(newSong);
		});
	}
}

// src/store/FileStoreState.ts - State ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
export class FileStoreState {
	constructor(readonly song: Song) {}
}
```

---

## 5. ãã®ä»–ã®å•é¡Œ

### 5.1 ParameterEditor å†…ã§ã®é‡è¤‡å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ParameterEditor/ParameterEditor.ts:350-396`

```typescript
private readonly selectionHandle: PianoRollHandle = {
	cursor: "edit",
	handlePointerDown: (ev) => {
		ev.addDragStartSessionListener((ev: PianoRollPointerEvent) => {
			const value = minmax(0, 1, 1 - ev.position.y / this.state.height);
			const velocity = Math.floor(value * 127);
			this.emit("change", channelId, selectedNoteIds, "velocity", velocity);
		});
		ev.addDragMoveSessionListener((ev: PianoRollPointerEvent) => {
			const value = minmax(0, 1, 1 - ev.position.y / this.state.height);
			const velocity = Math.floor(value * 127);
			this.emit("change", channelId, selectedNoteIds, "velocity", velocity);
		});
		ev.addDragEndSessionListener((ev: PianoRollPointerEvent) => {
			const value = minmax(0, 1, 1 - ev.position.y / this.state.height);
			const velocity = Math.floor(value * 127);
			this.emit("change", channelId, selectedNoteIds, "velocity", velocity);
		});
	},
};

private createNoteHandle(note: Note): PianoRollHandle {
	return {
		cursor: "edit",
		handlePointerDown: (ev) => {
			// â† åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒç¹°ã‚Šè¿”ã•ã‚Œã‚‹
			ev.addDragStartSessionListener((ev: PianoRollPointerEvent) => {
				const value = minmax(0, 1, 1 - ev.position.y / this.state.height);
				const velocity = Math.floor(value * 127);
				this.emit("change", channelId, [note.id], "velocity", velocity);
			});
			// ...
		},
	};
}
```

**å•é¡Œ**: Velocity è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãŒ3å›ç¹°ã‚Šè¿”ã•ã‚Œã‚‹

**æ¨å¥¨æ¡ˆ**:

```typescript
private calculateVelocityFromY(y: number): number {
	const value = minmax(0, 1, 1 - y / this.state.height);
	return Math.floor(value * 127);
}

private createDragSession(noteIds: number[]) {
	return {
		onStart: (ev: PianoRollPointerEvent) => {
			const velocity = this.calculateVelocityFromY(ev.position.y);
			this.emit("change", channelId, noteIds, "velocity", velocity);
		},
		onMove: (ev: PianoRollPointerEvent) => {
			const velocity = this.calculateVelocityFromY(ev.position.y);
			this.emit("change", channelId, noteIds, "velocity", velocity);
		},
		onEnd: (ev: PianoRollPointerEvent) => {
			const velocity = this.calculateVelocityFromY(ev.position.y);
			this.emit("change", channelId, noteIds, "velocity", velocity);
		},
	};
}

private readonly selectionHandle: PianoRollHandle = {
	cursor: "edit",
	handlePointerDown: (ev) => {
		const session = this.createDragSession(selectedNoteIds);
		ev.addDragStartSessionListener((e) => session.onStart(e));
		ev.addDragMoveSessionListener((e) => session.onMove(e));
		ev.addDragEndSessionListener((e) => session.onEnd(e));
	},
};
```

---

### 5.2 æœªå®Ÿè£…ã® TODO ã‚³ãƒ¡ãƒ³ãƒˆ

#### ParameterEditor

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/ParameterEditor/ParameterEditor.ts:57`
```typescript
if (!ev.metaKey) {
	// TODO: é¸æŠä¸­ã®ãƒãƒ¼ãƒˆã‚’æ›´æ–°
	// this.unselectAllNotes();
}
```

#### SoundFont

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/SoundFontSynthesizer/SoundFont.ts:1281`
```typescript
// ã‚µãƒ³ãƒ—ãƒ«ã®å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ«ãƒ¼ãƒ—è¨­å®šãªã©ï¼‰TODO
```

**æ¨å¥¨**: å®Ÿè£…ã™ã‚‹ã‹ã€æ„å›³çš„ã«å»¶æœŸã™ã‚‹å ´åˆã¯ç†ç”±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã€‚

---

## 6. æ”¹å–„å„ªå…ˆåº¦

### ğŸ”´ é«˜å„ªå…ˆåº¦ï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ ¹å¹¹ã«å½±éŸ¿ï¼‰

| # | é …ç›® | ç†ç”± | æ¨å®šå½±éŸ¿ |
|----|------|------|--------|
| 1 | **App.ts ã®è²¬å‹™åˆ†å‰²** | 21å€‹ã®ä¾å­˜æ€§ã€å…¨å±¤ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ | é«˜åº¦ã®ä¿å®ˆæ€§æ”¹å–„ |
| 2 | **PianoRollHandle ãªã©é‡è¤‡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®çµ±ä¸€** | å‹å®‰å…¨æ€§ã®å‘ä¸Šã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ | ä¸­åº¦ |
| 3 | **ParameterEditor â†” PianoRoll ã®å¯†çµåˆè§£é™¤** | EventBus æ´»ç”¨ã§å±¤é–“çµåˆåº¦ä½ä¸‹ | é«˜åº¦ã®æ‹¡å¼µæ€§å‘ä¸Š |
| 4 | **GetInstrument é–¢æ•°ã®å‰Šé™¤ã¾ãŸã¯è²¬å‹™æ˜ç¢ºåŒ–** | å†—é•·æ€§ã®æ’é™¤ | ä½åº¦ï¼ˆã‚³ãƒ¼ãƒ‰ç°¡æ½”æ€§ï¼‰ |

### ğŸŸ¡ ä¸­å„ªå…ˆåº¦ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ”¹å–„ï¼‰

| # | é …ç›® | ç†ç”± | æ¨å®šå½±éŸ¿ |
|----|------|------|--------|
| 5 | **ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®å…±é€šåŒ–ï¼ˆEventBus.emitWithPhasesï¼‰** | DRY åŸå‰‡ã€ä¿å®ˆæ€§ | ä¸­åº¦ |
| 6 | **State æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€** | å‚ç…§åŒä¸€æ€§ãƒã‚§ãƒƒã‚¯ã®ä¸€è²«æ€§ | ä½åº¦ |
| 7 | **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥ã®çµ±ä¸€** | äºˆæ¸¬å¯èƒ½æ€§ã€ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ | ä¸­åº¦ |
| 8 | **openFileSelectDialog/downloadText ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŒ–** | ã‚³ãƒ¼ãƒ‰ç°¡æ½”æ€§ | ä½åº¦ |

### ğŸŸ¢ ä½å„ªå…ˆåº¦ï¼ˆã‚³ãƒ¼ãƒ‰å“è³ªå‘ä¸Šï¼‰

| # | é …ç›® | ç†ç”± | æ¨å®šå½±éŸ¿ |
|----|------|------|--------|
| 9 | **Cursor å‹å‘½åã®çµ±ä¸€** | å‘½åä¸€è²«æ€§ | ä½åº¦ |
| 10 | **UseCase é–¢æ•°å‘½åã®çµ±ä¸€** | ëª…ëª… ì¼ê´€ì„± | ä½åº¦ |
| 11 | **ClipboardManager ã®è²¬å‹™åˆ†å‰²** | ë‹¨ì¼ì±…ì„ì›ì¹™ | ä¸­åº¦ï¼ˆæ‹¡å¼µæ™‚ï¼‰ |
| 12 | **ParameterEditor å†…ã®é‡è¤‡ãƒ­ã‚¸ãƒƒã‚¯æŠ½å‡º** | DRY åŸå‰‡ | ä½åº¦ |

---

## 7. ç·åˆè©•ä¾¡

### å¼·ã¿

âœ… **æ˜ç¢ºãªå±¤æ§‹é€ **: Model, UseCase, UI, Infrastructure ãŒæ¦‚ã­åˆ†é›¢
âœ… **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: EventBus ã§å±¤é–“çµåˆã‚’ä½ä¸‹ã•ã›ã¦ã„ã‚‹
âœ… **Undo/Redo ã®çµ±åˆ**: EditHistoryManager ã§é€éçš„ã«å®Ÿè£…
âœ… **æ•°å­¦çš„ã«å³å¯†**: MIDI å‡¦ç†ã®å„éƒ¨åˆ†ãŒè¨ˆç®—å¯èƒ½ã«è¨­è¨ˆ

### èª²é¡Œ

âš ï¸ **App.ts ã¸ã®éåº¦ãªè²¬å‹™é›†ç´„**: 21å€‹ã®ä¾å­˜æ€§ã¯å•é¡Œ
âš ï¸ **UIå±¤ã®å†…éƒ¨çµåˆ**: PianoRoll â†” ParameterEditor ã®å¯†çµåˆ
âš ï¸ **é‡è¤‡ã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©**: åŒã˜æ¦‚å¿µãŒè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©
âš ï¸ **å‘½åã®ä¸çµ±ä¸€**: Cursorå‹ã€é–¢æ•°å‘½åãªã©ã§ä¸€è²«æ€§æ¬ å¦‚

### æ”¹å–„åŠ¹æœã®è¦‹è¾¼ã¿

| æ”¹å–„é …ç›® | åŠ¹æœ | å®Ÿè£…é›£åº¦ |
|---------|------|--------|
| App.ts åˆ†å‰² | ã‚³ãƒ¼ãƒ‰ä¿å®ˆæ€§ â†‘â†‘ | é«˜ |
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çµ±ä¸€ | å‹å®‰å…¨æ€§ â†‘ | ä½ |
| PianoRoll â†” ParameterEditor ç–çµåˆåŒ– | æ‹¡å¼µæ€§ â†‘â†‘ | ä¸­ |
| å…¨ä½“çš„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° | æ–°æ©Ÿèƒ½è¿½åŠ é€Ÿåº¦ â†‘ | é«˜ |

---

## çµè«–

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ **åŸºæœ¬çš„ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆStateç®¡ç†ã€EventBusï¼‰ãŒè‰¯å¥½** ã§ã™ãŒã€ä»¥ä¸‹ã®ç‚¹ã§æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™:

1. **ä¸­å¤®é›†ç´„çš„ãªè¨­è¨ˆ** - App.ts ã¸ã®éåº¦ãªä¾å­˜é›†ç´„
2. **é‡è¤‡ã¨ä¸çµ±ä¸€** - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã®é‡è¤‡ã€å‘½åã®ä¸çµ±ä¸€
3. **å¯†çµåˆãª UI å±¤** - PianoRoll ã¨ ParameterEditor ã®çµåˆåº¦ãŒé«˜ã„

**æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
æ®µéšçš„ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’é€²ã‚ã‚‹å ´åˆã€**é«˜å„ªå…ˆåº¦é …ç›®ã‹ã‚‰é †ã«å®Ÿæ–½** ã—ã€å„æ®µéšã§æ—¢å­˜æ©Ÿèƒ½ã®å‹•ä½œã‚’ä¿è¨¼ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ç‰¹ã« App.ts ã®è²¬å‹™åˆ†å‰²ã¯ã€å…¨ä½“çš„ãªä¿å®ˆæ€§ã«å¤§ããªå½±éŸ¿ã‚’ä¸ãˆã¾ã™ã€‚

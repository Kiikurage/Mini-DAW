# MIDIã‚¨ãƒ‡ã‚£ã‚¿ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ—¥**: 2025-12-15
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: `/src` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã€ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ `7003d3b5b1c6cbce65f3f76e7fa3cc91efa22e8e`
**å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: `ca57a5d2c082def003fdb92482078f2ac9090b8e` (2025-12-14)
**ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹é‡**: ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã®è‰¯ã•ã€ã‚·ãƒ³ãƒ—ãƒ«ã•ã€æ‹¡å¼µå®¹æ˜“æ€§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹/å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®çµ±ä¸€æ„Ÿã‚’é‡è¦–

---

## ğŸ“‹ ç›®æ¬¡

1. [å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³](#1-å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³)
2. [æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°åˆ†æ](#2-æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°åˆ†æ)
3. [æ–°è¦ã«ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ](#3-æ–°è¦ã«ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡](#4-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡)
5. [ç·åˆè©•ä¾¡ã¨æ”¹å–„ææ¡ˆ](#5-ç·åˆè©•ä¾¡ã¨æ”¹å–„ææ¡ˆ)
6. [å„ªå…ˆåº¦åˆ¥æ”¹å–„ãƒªã‚¹ãƒˆ](#6-å„ªå…ˆåº¦åˆ¥æ”¹å–„ãƒªã‚¹ãƒˆ)

---

## 1. å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ã®æ”¹å–„çŠ¶æ³

### âŒ CRITICAL: Set vs Update å‘½åã®ä¸çµ±ä¸€ - **æœªè§£æ±º**

**å‰å›ã®æŒ‡æ‘˜**: Song ãƒ¢ãƒ‡ãƒ«ã¨ Channel ãƒ¢ãƒ‡ãƒ«ã§ã€Œsetã€ã¨ã€Œupdateã€ã®æ„å‘³ãŒéå¯¾ç§°

**ç¾åœ¨ã®çŠ¶æ…‹**: âŒ **æ”¹å–„ã•ã‚Œã¦ã„ãªã„**

#### å•é¡Œã®è©³ç´°

**Song ãƒ¢ãƒ‡ãƒ«** (`src/models/Song.ts:73-84`):
```typescript
setTitle(title: string): Song { ... }
setBPM(bpm: number): Song { ... }
applyPatch(patch: SongPatch): Song { ... }
```

**Channel ãƒ¢ãƒ‡ãƒ«** (`src/models/Channel.ts:83-91`):
```typescript
setLabel(label: string): Channel { ... }
setInstrumentKey(key: InstrumentKey): Channel { ... }
applyPatch(patch: ChannelPatch): Channel { ... }
```

**EventBus ã‚¤ãƒ™ãƒ³ãƒˆå‘½å** (`src/EventBus.ts`):
- `"song.set"` - å…¨ç½®æ›æ“ä½œ
- `"song.update"` - éƒ¨åˆ†æ›´æ–°æ“ä½œ
- `"channel.update"` - éƒ¨åˆ†æ›´æ–°æ“ä½œ

**å•é¡Œç‚¹**:
- ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚½ãƒƒãƒ‰: `set*()` = å…¨ç½®æ›ã€`applyPatch()` = éƒ¨åˆ†æ›´æ–°
- ã‚¤ãƒ™ãƒ³ãƒˆ: `"song.set"` = å…¨ç½®æ›ã€`"song.update"` = éƒ¨åˆ†æ›´æ–°
- å‘¼ã³å‡ºã—å´ã§ã®æ„å›³ãŒä¸æ˜ç¢º

**æ¨å¥¨ã•ã‚Œã‚‹çµ±ä¸€**:

Option A: å®Œå…¨ãªçµ±ä¸€
```typescript
// ãƒ¢ãƒ‡ãƒ«å±¤
setTitle()         // å…¨ç½®æ›
updateTitle()      // éƒ¨åˆ†æ›´æ–°ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯å®Ÿè£…ä¸è¦ï¼‰

// ã‚¤ãƒ™ãƒ³ãƒˆå±¤
"song.set"         // å…¨ç½®æ›
"song.update"      // éƒ¨åˆ†æ›´æ–°
```

Option B: å‹•è©ã‚’ã€Œapplyã€ã«çµ±ä¸€
```typescript
setSong(song)           // å…¨ç½®æ›
applyPatch(patch)       // éƒ¨åˆ†æ›´æ–°
```

**å„ªå…ˆåº¦**: ğŸ”´ **HIGH** - APIã®ç†è§£æ€§ã«ç›´çµ

---

### âš ï¸ CRITICAL: select/selectOnly å‘½åã®ä¸çµ±ä¸€ - **éƒ¨åˆ†æ”¹å–„**

**å‰å›ã®æŒ‡æ‘˜**: Editor.ts ã® selectNotes ã¨ setSelectedNotes ã®å‘½åãŒé€†è»¢ã—ã¦ã„ã‚‹

**ç¾åœ¨ã®çŠ¶æ…‹**: âš ï¸ **æ”¹å–„ã•ã‚Œã¦ã„ãªã„**

#### å•é¡Œã®è©³ç´°

**Editor.ts** (`src/Editor/Editor.ts:215-230`):
```typescript
selectAllNotes(): void { ... }              // ??? å…¨é¸æŠã‹?
unselectAllNotes(): void { ... }            // å…¨å‰Šé™¤
setSelectedNotes(noteIds): void { ... }     // å…¨ç½®æ›
selectNotes(noteIds): void { ... }          // è¿½åŠ 
unselectNotes(noteIds): void { ... }        // å‰Šé™¤
```

**ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ã®æ··ä¹±**:
- `selectAllNotes()` ã¨ `setSelectedNotes()` ãŒåŒã˜æ„å‘³?
- `selectNotes()` ã¯ã€Œè¿½åŠ ã€ãªã®ã«ã€é ­ã®å‹•è©ãŒã€Œselectã€(ç½®æ›ã£ã½ã„)
- `unselectNotes()` ã¯ã€Œå‰Šé™¤ã€ã ãŒã€prefix ãŒã€Œunselectã€(å¦å®š)

**æ¨å¥¨ã•ã‚Œã‚‹å‘½å** (ã‚ˆã‚Šæ˜ç¢º):
```typescript
setSelectedNotes(noteIds)        // å…¨ç½®æ›ï¼ˆç¾åœ¨ã® setSelectedNotesï¼‰
addSelectedNotes(noteIds)        // è¿½åŠ ï¼ˆç¾åœ¨ã® selectNotesï¼‰
removeSelectedNotes(noteIds)     // å‰Šé™¤ï¼ˆç¾åœ¨ã® unselectNotesï¼‰
clearSelectedNotes()             // å…¨å‰Šé™¤ï¼ˆç¾åœ¨ã® unselectAllNotesï¼‰
selectAllNotes()                 // å…¨é¸æŠï¼ˆæ–°è¦ï¼‰
```

**å„ªå…ˆåº¦**: ğŸ”´ **HIGH** - UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æ“ä½œæ„Ÿã«å½±éŸ¿

---

### âš ï¸ HIGH: å‹ã‚­ãƒ£ã‚¹ãƒˆã®ä¹±ç”¨ - **æœªè§£æ±º**

**å‰å›ã®æŒ‡æ‘˜**: InstrumentKey ã®å‹ã‚­ãƒ£ã‚¹ãƒˆãŒå¤šæ•°å­˜åœ¨

**ç¾åœ¨ã®çŠ¶æ…‹**: âŒ **æ”¹å–„ã•ã‚Œã¦ã„ãªã„** - ã‚€ã—ã‚å¢—åŠ 

#### å•é¡Œã®è©³ç´°

**ToolBar.tsx** (`src/ToolBar/ToolBar.tsx`):
- L67: `const instrumentKey = activeChannel.instrumentKey as SoundFontInstrumentKey;`
- L103: `(activeChannel.instrumentKey as SoundFontInstrumentKey).presetNumber`
- L109: `activeChannel.instrumentKey as PreInstalledSoundFontInstrumentKey`
- L122-123: `(activeChannel.instrumentKey as SoundFontInstrumentKey).presetNumber`
- L129, 132-133: è¤‡æ•°ã® nested cast

**SoundFontDialog.tsx** (`src/InstrumentDialog/SoundFontDialog.tsx:63`):
```typescript
controller.channel.instrumentKey as PreInstalledSoundFontInstrumentKey
```

**å•é¡Œç‚¹**:
- InstrumentKey ã¯ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã§è¤‡æ•°ã®ç¨®é¡ãŒã‚ã‚‹
- ã‚­ãƒ£ã‚¹ãƒˆã¯å‹ãƒã‚§ãƒƒã‚¯ãªã—ã§ã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã®ãƒªã‚¹ã‚¯
- ã‚³ãƒ¼ãƒ‰ã®æ„å›³ãŒä¸æ˜ç¢º

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```typescript
// å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã‚’è¿½åŠ 
function isSoundFontInstrumentKey(
    key: InstrumentKey,
): key is SoundFontInstrumentKey {
    return "url" in key && "bankNumber" in key && "presetNumber" in key;
}

function isPreInstalledSoundFontInstrumentKey(
    key: InstrumentKey,
): key is PreInstalledSoundFontInstrumentKey {
    return "name" in key && "url" in key && "bankNumber" in key;
}

// ä½¿ç”¨ä¾‹
if (isSoundFontInstrumentKey(instrumentKey)) {
    const presetNumber = instrumentKey.presetNumber;  // å‹å®‰å…¨
}
```

**å„ªå…ˆåº¦**: ğŸ”´ **HIGH** - ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å®‰å…¨æ€§ã«é–¢ã‚ã‚‹

---

### âœ… GOOD: marqueeArea å‹ã®ä¸€è²«æ€§ - **è§£æ±ºæ¸ˆã¿**

**å‰å›ã®æŒ‡æ‘˜**: marqueeArea ã®å‹å®šç¾©ãŒ ParameterEditor ã¨ PianoRoll ã§ç•°ãªã£ã¦ã„ãŸ

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… **è§£æ±ºæ¸ˆã¿**

**æ”¹å–„ç¢ºèª**:
- `src/models/PianoRollArea.ts` ã§çµ±ä¸€ã•ã‚ŒãŸå‹å®šç¾©ãŒå­˜åœ¨
- PianoRoll ã¨ ParameterEditor ä¸¡è€…ã§åŒã˜å‹ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹
- å‹ã®ä¸€è²«æ€§ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹

**è©•ä¾¡**: âœ… è‰¯å¥½

---

### âš ï¸ MEDIUM: EventBus ãƒªã‚¹ãƒŠãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— - **éƒ¨åˆ†å®Ÿè£…**

**å‰å›ã®æŒ‡æ‘˜**: EventEmitter ã« unsubscribe æ©Ÿèƒ½ãŒã‚ã‚‹ãŒã€Store ã§ä½¿ã‚ã‚Œã¦ã„ãªã„

**ç¾åœ¨ã®çŠ¶æ…‹**: âš ï¸ **ç¶™ç¶šã—ã¦æœªå®Ÿè£…**

#### å•é¡Œã®è©³ç´°

**EventEmitter.ts** (`src/EventBus/EventEmitter.ts:20-32`):
```typescript
off<K extends keyof E>(
    eventName: K,
    callback: (...args: E[K]) => void,
): this {
    const callbacks = this.callbackMap.get(eventName as string);
    if (callbacks !== undefined) {
        callbacks.delete(callback as (...args: unknown[]) => void);
        // ...
    }
    return this;
}
```

âœ“ `off()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

**SongStore.ts** (`src/SongStore.ts:11-31`):
```typescript
constructor(bus: EventBus) {
    super(new Song());
    bus
        .on("channel.add", (channel) => { ... })     // âŒ å‰Šé™¤ã•ã‚Œãªã„
        .on("channel.delete", (channelId) => { ... })
        .on("channel.update", (channelId, patch) => { ... })
        .on("notes.set", (channelId, notes) => { ... })
        .on("notes.delete", (channelId, noteIds) => { ... })
        .on("song.set", (song) => { ... })
        .on("song.update", (patch) => { ... });
}
```

**InstrumentStore.ts** (`src/InstrumentStore.ts:47-60`):
```typescript
constructor(bus: EventBus) {
    bus
        .on("song.set.after", (song) => { ... })     // âŒ å‰Šé™¤ã•ã‚Œãªã„
        .on("channel.add.after", (channel) => { ... })
        .on("channel.update.after", (channelId, patch) => { ... })
}
```

**å•é¡Œç‚¹**:
- Singleton ãªãŸã‚å®Ÿå®³ã¯ä½ã„ãŒã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®ãƒªã‚¹ã‚¯å­˜åœ¨
- ã‚³ãƒ¼ãƒ‰å“è³ªã¨ã—ã¦ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ã¦ã„ãªã„
- ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ç’°å¢ƒã§ã®é‡è¤‡ç™»éŒ²ã®å¯èƒ½æ€§

**æ¨å¥¨ã•ã‚Œã‚‹æ”¹å–„**:

```typescript
export class SongStore extends Stateful<Song> {
    private unsubscribers: Array<() => void> = [];

    constructor(bus: EventBus) {
        super(new Song());

        this.unsubscribers.push(
            bus.on("channel.add", (channel) => { ... }),
            bus.on("channel.delete", (channelId) => { ... }),
            // ...
        );
    }

    dispose(): void {
        this.unsubscribers.forEach(unsub => unsub());
    }
}
```

**å„ªå…ˆåº¦**: ğŸŸ¡ **MEDIUM** - å®Ÿå®³ã¯ç¾çŠ¶ã§ã¯ä½ã„ãŒã€å°†æ¥çš„ãªå•é¡Œé˜²æ­¢

---

## 2. æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®è©³ç´°åˆ†æ

### ã‚³ãƒŸãƒƒãƒˆ: "Refactor Editor"

**å¤‰æ›´å†…å®¹**: ã‚¨ãƒ‡ã‚£ã‚¿çŠ¶æ…‹ç®¡ç†ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

#### 2.1 å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

- `src/Editor/PianoRoll/PianoRollState.ts` (202è¡Œ)
- `src/Editor/ParameterEditor/ParameterEditorState.ts` (84è¡Œ)

**åˆè¨ˆå‰Šé™¤è¡Œæ•°**: 286è¡Œ

#### 2.2 å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

**PianoRoll.ts**:
- å‰å›: ~712è¡Œ
- ç¾åœ¨: ~896è¡Œ
- **å¢—åŠ **: 184è¡Œ (25.8% å¢—)

**ParameterEditor.ts**:
- çŠ¶æ…‹ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ãŒçµ„ã¿è¾¼ã¾ã‚ŒãŸ

#### 2.3 è©•ä¾¡

**ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå´é¢** âœ…:
- çŠ¶æ…‹ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ãŒçµ±åˆã•ã‚Œã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ãŒç°¡æ½”ã«
- åˆ†æ•£ã—ã¦ã„ãŸé€»è¾‘ãŒä¸€ç®‡æ‰€ã«

**ãƒã‚¬ãƒ†ã‚£ãƒ–ãªå´é¢** âŒ:
- ã‚¯ãƒ©ã‚¹ã®è²¬å‹™ãŒå¢—åŠ 
- ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§ãŒä½ä¸‹
- PianoRoll ã®è‚¥å¤§åŒ–ãŒåŠ é€Ÿ (æ—¢ã«æ‡¸å¿µäº‹é …)

**ç·åˆè©•ä¾¡**: âš ï¸ **ä¸­ç«‹çš„ï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚ã‚Šï¼‰**

---

## 3. æ–°è¦ã«ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ

### 3.1 ğŸ”´ CRITICAL: PianoRoll ã‚¯ãƒ©ã‚¹ã®éåº¦ãªè²¬å‹™

**Location**: `src/Editor/PianoRoll/PianoRoll.ts` (~896è¡Œ)

#### ç¢ºèªã•ã‚ŒãŸè²¬å‹™

1. **çŠ¶æ…‹ç®¡ç†** (L1-100): hoveredNoteIds, cursor, scrollTop ãªã©
2. **ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿ** (L200-250): startPreviewNotes, stopPreviewNotes, cancelPreviewChannel
3. **ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†** (L300-500): PointerEventManagerDelegate å®Ÿè£…
4. **ãƒ’ãƒƒãƒˆæ¤œæŸ»** (L337-413): ãƒãƒ¼ãƒˆã€é¸æŠã‚¨ãƒªã‚¢ã€ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®è¡çªåˆ¤å®š
5. **ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†** (L500-700): 7ç¨®é¡ã®ãƒãƒ³ãƒ‰ãƒ«ä½œæˆãƒ»æ“ä½œ
6. **é¸æŠã‚¨ãƒªã‚¢ç®¡ç†** (L465-477): marquee selection ãƒ­ã‚¸ãƒƒã‚¯
7. **ãƒãƒ¼ãƒˆä½œæˆ** (L700-750): ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ã‹ã‚‰ã®ãƒãƒ¼ãƒˆç”Ÿæˆ
8. **ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢é€£** (L800-896): Canvas ç”¨ã®ãƒ‡ãƒ¼ã‚¿è¨ˆç®—

#### è¤‡é›‘æ€§ãƒ¡ãƒˆãƒªã‚¯ã‚¹

- **ãƒ¡ã‚½ãƒƒãƒ‰æ•°**: 25+
- **ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼**: 8+
- **æ¡ä»¶åˆ†å²ã®æ·±ã•**: å¹³å‡ 4-5 æ®µéš
- **å˜ä¸€ãƒ¡ã‚½ãƒƒãƒ‰è¡Œæ•°**: æœ€å¤§ 50+ è¡Œ

#### æ¨å¥¨ã•ã‚Œã‚‹åˆ†é›¢

```typescript
// ææ¡ˆã™ã‚‹åˆ†å‰²æ§‹é€ :
class PianoRoll {
    private eventHandler: PianoRollEventHandler;
    private selectionHandler: NoteSelectionHandler;
    private previewManager: PreviewManager;
    // ...
}

class PianoRollEventHandler implements PointerEventManagerDelegate {
    handlePointerDown(ev: PointerEvent) { ... }
    findHandle(position) { ... }
}

class NoteSelectionHandler {
    startMarqueeSelection(position) { ... }
    moveMarqueeSelection(position) { ... }
    endMarqueeSelection() { ... }
}

class PreviewManager {
    startPreviewNotes(noteIds) { ... }
    stopPreviewNotes(noteIds) { ... }
}
```

**å„ªå…ˆåº¦**: ğŸŸ¡ **MEDIUM** - ä¿å®ˆæ€§ã«é–¢ã‚ã‚‹ï¼ˆç¾åœ¨ã§ã‚‚å‹•ä½œã™ã‚‹ãŒã€å°†æ¥çš„ãªæ‹¡å¼µãŒå›°é›£ï¼‰

---

### 3.2 ğŸŸ¡ MEDIUM: é‡è¤‡ã—ã¦ã„ãŸ bankNumber typo ã®ä¿®æ­£ç¢ºèª

**å‰å›ã®æ‡¸å¿µ**: `bunkNumber` ã¨ã„ã† typo ãŒå­˜åœ¨ã—ã¦ã„ãŸå¯èƒ½æ€§

**ç¾åœ¨ã®çŠ¶æ…‹**: âœ… **ç¢ºèªä¸å¯ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰**

**Location**: `src/SoundFontInstrument.ts`
- L44: `bankNumber: this.bankNumber,` âœ“
- L101: `bankNumber: this.bankNumber,` âœ“
- ä»–ã™ã¹ã¦ã®ç®‡æ‰€ã§æ­£ã—ã `bankNumber` ã‚’ä½¿ç”¨

**è©•ä¾¡**: âœ… **Good** - typo ã¯å­˜åœ¨ã—ãªã„

---

### 3.3 ğŸŸ¡ MEDIUM: Accessibility é•å

#### Issue 1: ListBox ã® WAI-ARIA éæº–æ‹ 

**Location**: `src/react/ListBox/ListBox.tsx:36`
```typescript
<li
    role="option"  // âš ï¸ liè¦ç´ ã« role="option" ã¯æ¨å¥¨ã•ã‚Œãªã„
    biome-ignore lint/a11y/noNoninteractiveElementToInteractiveRole
>
```

**å•é¡Œ**: WAI-ARIA ã§ã¯ `role="option"` ã¯ `<select>` ã‚„ `<listbox>` ã®å­è¦ç´ ã¨ã—ã¦å®šç¾©ã•ã‚Œã‚‹ã¹ãã§ã€`<li>` å˜ç‹¬ã§ã®ä½¿ç”¨ã¯æ¨å¥¨ã•ã‚Œãªã„

**æ”¹å–„æ¡ˆ**:
```typescript
<li
    role="option"
    aria-selected={selectedId === option.id}
    tabIndex={selectedId === option.id ? 0 : -1}
>
```

---

#### Issue 2: ToolBar ã®éã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ HTML

**Location**: `src/ToolBar/ToolBar.tsx:190-211`
```typescript
<span
    onClick={() => { /* title edit */ }}
    // biome-ignore lint/a11y/noStaticElementInteractions
    // biome-ignore lint/a11y/useKeyWithClickEvents
>
    {song.title}
</span>
```

**å•é¡Œ**:
- `<span>` ã¯ ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã®ãªã„è¦ç´ 
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„
- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã§æ“ä½œä¸å¯èƒ½

**æ”¹å–„æ¡ˆ**:
```typescript
<button
    onClick={() => { /* title edit */ }}
    onKeyDown={(e) => e.key === "Enter" && /* edit */}
    aria-label="Edit song title"
>
    {song.title}
</button>
```

**å„ªå…ˆåº¦**: ğŸŸ¡ **MEDIUM** - WCAG AA æº–æ‹ ã®ãŸã‚

---

### 3.4 ğŸŸ¢ LOW: ä¸å®Œå…¨ãª TODO ã‚³ãƒ¡ãƒ³ãƒˆ

**Location**: `src/SoundFont/InstrumentZone.ts:232`
```typescript
// ã‚µãƒ³ãƒ—ãƒ«ã®å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ«ãƒ¼ãƒ—è¨­å®šãªã©ï¼‰TODO
```

**å•é¡Œ**: TODO ã®å¾Œã«å®Ÿè£…ãŒã‚ã‚‹ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆãŒèª¤è§£ã‚’æ‹›ãå¯èƒ½æ€§

**æ”¹å–„æ¡ˆ**:
```typescript
// Note: Sample loop modes are partially implemented below.
// TODO: Add support for reverse playback and bidirectional loops
```

---

### 3.5 ğŸŸ¢ LOW: é‡è¤‡ã—ãŸã‚³ãƒ¼ãƒ‰ ãƒ‘ã‚¿ãƒ¼ãƒ³

#### Pattern 1: marquee é¸æŠãƒ­ã‚¸ãƒƒã‚¯

**PianoRoll.ts** (L465-477):
```typescript
const startMarquee = () => { ... };
const moveMarquee = () => { ... };
const endMarquee = () => { ... };
```

**ParameterEditor.ts** (L169-206):
ã»ã¼åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåº§æ¨™ç³»ã®ã¿ç•°ãªã‚‹ï¼‰

**æ¨å¥¨**: å…±é€šã® `MarqueeSelectionHandler` ã‚¯ãƒ©ã‚¹ã‚’æŠ½å‡º

---

## 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡

### 4.1 å±¤æ§‹é€ ã®å®‰å®šæ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        React Presentation Layer (Component)         â”‚
â”‚  AppView, ToolBar, ChannelListView, StatusBar       â”‚
â”‚  ListBox, PopUp, Select, InstrumentSelect           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Application Layer (Business Logic)                â”‚
â”‚   Editor, PianoRoll, ParameterEditor                â”‚
â”‚   PointerEventManager, KeyboardHandler              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Use Case Layer (Phased-Event-based)               â”‚
â”‚   âœ… emitPhasedEvents ã§çµ±ä¸€                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Infrastructure Layer (Event-driven)               â”‚
â”‚   EventBus, EditHistory, Stores                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Domain Layer (Immutable Models)                   â”‚
â”‚   Song, Channel, Note, Instrument                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è©•ä¾¡**: âœ… **9/10** - å±¤æ§‹é€ ã¯å¼•ãç¶šãæ˜ç¢ºã§å …å®Ÿ

### 4.2 DI ãƒ‘ã‚¿ãƒ¼ãƒ³ ã®æœ‰åŠ¹æ€§

**Current Implementation** (`src/deps.tsx`):
```typescript
.set(PianoRoll.Key, (deps) => {
    return new PianoRoll(
        deps.get(InstrumentStore.Key),
        deps.get(SongStore.Key),
        deps.get(SetNotesKey),
        deps.get(MoveNotesKey),
        deps.get(DeleteNotesKey),
        deps.get(Player.Key),
        deps.get(Editor.Key),
        deps.get(EventBus.Key),
    );
})
```

**è©•ä¾¡**: âœ… **8.5/10** - ç¶™ç¶šã—ã¦åŠ¹æœçš„

### 4.3 Immutable State ãƒ‘ã‚¿ãƒ¼ãƒ³

**è©•ä¾¡**: âœ… **9/10** - å …å®Ÿã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

### 4.4 Phased Events ãƒ‘ã‚¿ãƒ¼ãƒ³

**è©•ä¾¡**: âœ… **10/10** - å®Œå…¨ã«çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹

---

## 5. ç·åˆè©•ä¾¡ã¨æ”¹å–„ææ¡ˆ

### ğŸ“Š ã‚¹ã‚³ã‚¢æ¨ç§»

| æŒ‡æ¨™ | å‰å› (ca57a5d) | ç¾åœ¨ (7003d3b) | å¤‰åŒ– |
|------|-------|-------|--------|
| ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | 9/10 | 9/10 | Â±0% |
| å‘½åã®ä¸€è²«æ€§ | 6/10 | 6/10 | Â±0% (set/updateã€select æœªè§£æ±º) |
| å‹å®‰å…¨æ€§ | 7/10 | 6.5/10 | **-7%** (typo cast ãŒå¢—åŠ å‚¾å‘) |
| ã‚¯ãƒ©ã‚¹è¨­è¨ˆ | 8/10 | 7/10 | **-12.5%** (PianoRoll è‚¥å¤§åŒ–) |
| ã‚³ãƒ¼ãƒ‰ä¿å®ˆæ€§ | 8/10 | 7.5/10 | **-6.3%** |
| **ç·åˆã‚¹ã‚³ã‚¢** | **7.6/10** | **7.1/10** | **-6.6%** âš ï¸ |

### å¼·ã¿ âœ…

1. **å±¤æ§‹é€ ã®æ˜ç¢ºæ€§**: Model â†’ Use Case â†’ Presentation ãŒé©åˆ‡ã«åˆ†é›¢
2. **Phased Events ãƒ‘ã‚¿ãƒ¼ãƒ³**: EventBus ã®è¨­è¨ˆãŒå®Œå…¨ã«çµ±ä¸€
3. **Immutable è¨­è¨ˆ**: State ç®¡ç†ã®å®‰å…¨æ€§ãŒé«˜ã„
4. **DI Container**: ä¾å­˜æ€§ç®¡ç†ãŒæ˜ç¤ºçš„ã§æ‹¡å¼µæ€§ã«å„ªã‚Œã¦ã„ã‚‹
5. **React ãƒ‘ã‚¿ãƒ¼ãƒ³**: useStateful ã®ä¸€è²«ã—ãŸä½¿ç”¨

### èª²é¡Œ âš ï¸

1. **Set vs Update å‘½å**: ä¾ç„¶ã¨ã—ã¦çµ±ä¸€ã•ã‚Œã¦ã„ãªã„
2. **Select/Unselect å‘½å**: ã‚»ãƒãƒ³ãƒ†ã‚£ã‚¯ã‚¹ãŒæ›–æ˜§
3. **å‹ã‚­ãƒ£ã‚¹ãƒˆ**: `as SoundFontInstrumentKey` ãŒè¤‡æ•°ç®‡æ‰€
4. **PianoRoll è‚¥å¤§åŒ–**: è²¬å‹™ãŒ 8+ ã«å¢—åŠ 
5. **ãƒªã‚¹ãƒŠãƒ¼ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«**: Store ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒæœªå®Ÿè£…
6. **Accessibility**: WAI-ARIA æº–æ‹ ãŒä¸è¶³

---

## 6. å„ªå…ˆåº¦åˆ¥æ”¹å–„ãƒªã‚¹ãƒˆ

### ğŸ”´ CRITICAL (å³åº§ã«å¯¾å¿œ)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | ãƒ•ã‚¡ã‚¤ãƒ« |
|----|------|------|--------|---------|
| 1 | å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã®å°å…¥ | ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å®‰å…¨æ€§ | 1h | ToolBar.tsx, SoundFontDialog.tsx |
| 2 | select/selectOnly å‘½åçµ±ä¸€ | API ã®æ˜ç¢ºåŒ– | 1-2h | Editor.ts |

---

### ğŸŸ¡ HIGH (æ¬¡ã‚¹ãƒ—ãƒªãƒ³ãƒˆ)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | ãƒ•ã‚¡ã‚¤ãƒ« |
|----|------|------|--------|---------|
| 3 | Set vs Update å‘½åçµ±ä¸€ | å‘½åä¸€è²«æ€§ | 2-3h | å…¨ä½“ |
| 4 | EventBus ãƒªã‚¹ãƒŠãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— | ãƒ¡ãƒ¢ãƒªå®‰å…¨æ€§ | 1h | Stores |
| 5 | Accessibility å¯¾å¿œ | WCAG æº–æ‹  | 1-2h | ToolBar.tsx, ListBox.tsx |

---

### ğŸŸ¢ MEDIUM (å°†æ¥çš„)

| # | é …ç›® | ç†ç”± | æ¨å®šå·¥æ•° | ãƒ•ã‚¡ã‚¤ãƒ« |
|----|------|------|--------|---------|
| 6 | PianoRoll ã®è²¬å‹™åˆ†é›¢ | ä¿å®ˆæ€§å‘ä¸Š | 4-6h | Editor/PianoRoll/ |
| 7 | marquee é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã®çµ±åˆ | DRY åŸå‰‡ | 2h | Editor/ |

---

## çµè«–

**ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹**: 7.1/10 (å‰å› 8/10 ã‹ã‚‰ 0.9 ãƒã‚¤ãƒ³ãƒˆä½ä¸‹)

**è©•ä¾¡**:
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å±¤æ§‹é€ ã¯å¼•ãç¶šãå …å®Ÿ
- Phased Events ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå®Œå…¨ã«çµ±ä¸€
- ãŸã ã—ã€å‘½åã®ä¸€è²«æ€§å•é¡ŒãŒæœªè§£æ±ºã®ã¾ã¾
- PianoRoll ã®è‚¥å¤§åŒ–ãŒé€²è¡Œä¸­
- å‹å®‰å…¨æ€§ã«æ‡¸å¿µ

**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:

**ãƒ•ã‚§ãƒ¼ã‚º 1 (1-2æ—¥)**:
1. å‹ã‚¬ãƒ¼ãƒ‰é–¢æ•°ã‚’å°å…¥ã—ã¦ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å®‰å…¨æ€§ã‚’å¼·åŒ–
2. select/selectOnly ã®å‘½åã‚’çµ±ä¸€

**ãƒ•ã‚§ãƒ¼ã‚º 2 (3-5æ—¥)**:
3. Set vs Update ã®å‘½åè¦ç´„ã‚’ç¢ºç«‹
4. Store ã® EventBus ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
5. Accessibility å•é¡Œã‚’ä¿®æ­£

**ãƒ•ã‚§ãƒ¼ã‚º 3 (1-2é€±é–“)**:
6. PianoRoll ã®è²¬å‹™ã‚’åˆ†é›¢
7. marquee é¸æŠãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±é€šåŒ–

**å…¨ä½“çš„ãªæ–¹å‘æ€§**: âš ï¸ **è¦æ³¨æ„** - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯å …å®Ÿã ãŒã€å‘½åã¨å‹å®‰å…¨æ€§ã®æ”¹å–„ãŒæ€¥å‹™

---

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†æ—¥**: 2025-12-15
**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½è€…**: Claude Code
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 100+ TypeScript ãƒ•ã‚¡ã‚¤ãƒ«
**ç·ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: ~12,500 è¡Œ (æ¨å®š)
**æ¯”è¼ƒå¯¾è±¡**: REVIEW_RESULT_20251214_224110.md (å‰å›ãƒ¬ãƒ“ãƒ¥ãƒ¼)
